
let PathData =  {
  nameEn: null,
  nameAr: null,
  callStatusFieldId: null,
  noteId: null,
  subNoteId: null,
  otherNoteId: null,
  callBillNumberId: null,
  visitCenterTime: null,
  visitCenter: null,
  nhcProject: null,
  nhcSuburb: null,
  pathGroups: [
    {
      id: null,
      name: null,
      viewOrder: 0,
      title: null,
      type: null,
      groupFields: [
        {
          id: null,
          fieldTypeId: null,
          name: null,
          viewOrder: 0,
          isReadOnly: false,
          isRequired: false,
          isReportExportable: false,
          isForVisitReport: false,
          isForSpecialSammaryReport: false,
          title: null,
          type: null,
          unified: 0,
          isOptionRelatedToEntity: false,
          optionsRelatedToEntityId: null,
          fieldOption: [
            {
              id: null,
              name: null,
              isActive: 0,
              relatedCategoryPathFieldId: null,
              relatedEntityOptionId: null,
              relatedEntityId: null,
              viewOrder: 0,
              showIfCondetionGroup: [
                {
                  id: null,
                  relatedCategoryPathFieldOptionId: null,
                  conditionForId: null,
                  andorOr: false,
                  conditions: [
                    {
                      id: null,
                      fieldId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      relatedCategoryPathFieldId: null,
                      relatedEntityId: null,
                      relatedEntityOptionId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ],
              selectedIfCondetionGroup: [
                {
                  id: null,
                  relatedCategoryPathFieldOptionId: null,
                  conditionForId: null,
                  andorOr: false,
                  conditions: [
                    {
                      id: null,
                      fieldId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      relatedCategoryPathFieldId: null,
                      relatedEntityId: null,
                      relatedEntityOptionId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ],
              disabledIfCondetionGroup: [
                {
                  id: null,
                  relatedCategoryPathFieldOptionId: null,
                  conditionForId: null,
                  andorOr: false,
                  conditions: [
                    {
                      id: null,
                      fieldId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      relatedCategoryPathFieldId: null,
                      relatedEntityId: null,
                      relatedEntityOptionId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ]
            }
          ],
          showIfCondetionGroup: [
            {
              id: null,
              relatedToCategoryPathFieldId: null,
              categoryPathFieldEventGroupId: null,
              conditionForId: null,
              andorOr: false,
              viewOrder: 0,
              conditions: [
                {
                  id: null,
                  fieldConditionGroupId: null,
                  fieldId: null,
                  conditionForId: null,
                  conditionTypeId: null,
                  value: null,
                  andorOr: false,
                  viewOrder: 0,
                  valueList: [null],
                  conditionRelationTypeId: null,
                  categoryPathFieldRelatedEntityFieldId: null
                }
              ]
            }
          ],
          readOnlyIfCondetionGroup: [
            {
              id: null,
              relatedToCategoryPathFieldId: null,
              categoryPathFieldEventGroupId: null,
              conditionForId: null,
              andorOr: false,
              viewOrder: 0,
              conditions: [
                {
                  id: null,
                  fieldConditionGroupId: null,
                  fieldId: null,
                  conditionForId: null,
                  conditionTypeId: null,
                  value: null,
                  andorOr: false,
                  viewOrder: 0,
                  valueList: [null],
                  conditionRelationTypeId: null,
                  categoryPathFieldRelatedEntityFieldId: null
                }
              ]
            }
          ],
          disabledIfCondetionGroup: [
            {
              id: null,
              relatedToCategoryPathFieldId: null,
              categoryPathFieldEventGroupId: null,
              conditionForId: null,
              andorOr: false,
              viewOrder: 0,
              conditions: [
                {
                  id: null,
                  fieldConditionGroupId: null,
                  fieldId: null,
                  conditionForId: null,
                  conditionTypeId: null,
                  value: null,
                  andorOr: false,
                  viewOrder: 0,
                  valueList: [null],
                  conditionRelationTypeId: null,
                  categoryPathFieldRelatedEntityFieldId: null
                }
              ]
            }
          ],
          eventsGroup: [
            {
              id: null,
              events: [
                {
                  id: null,
                  actionTypeId: null,
                  dynamicFunctionId: null,
                  dynamicFunctionIdentifire: null,
                  parameters: [
                    {
                      id: null,
                      name: null,
                      parameterIdentifire: null,
                      parameterId: null,
                      categoryPathFieldId: null,
                      staticValue: null,
                      isRelatedToPathFields: false,
                      fieldShouldRelatedToEntityTypeId: null
                    }
                  ],
                  results: [
                    {
                      id: null,
                      name: null,
                      outputIdentifire: null,
                      resultId: null,
                      categoryPathFieldId: null,
                      isNotification: false,
                      isPathResult: false,
                      isPathValue: false
                    }
                  ],
                  processOrder: 0
                }
              ],
              executeTrigger: {
                additionalProp1: false,
                additionalProp2: false,
                additionalProp3: false
              },
              executeIfCondetionGroup: [
                {
                  id: null,
                  relatedToCategoryPathFieldId: null,
                  categoryPathFieldEventGroupId: null,
                  conditionForId: null,
                  andorOr: false,
                  viewOrder: 0,
                  conditions: [
                    {
                      id: null,
                      fieldConditionGroupId: null,
                      fieldId: null,
                      conditionForId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      conditionRelationTypeId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ],
              andorOr: false,
              processOrder: 0
            }
          ]
        }
      ]
    }
  ],
  eventGroups: [
    {
      id: null,
      events: [
        {
          id: null,
          actionTypeId: null,
          dynamicFunctionId: null,
          parameters: [
            {
              id: null,
              name: null,
              parameterIdentifire: null,
              parameterId: null,
              categoryPathFieldId: null,
              staticValue: null,
              isRelatedToPathFields: false,
              fieldShouldRelatedToEntityTypeId: null
            }
          ],
          results: [
            {
              id: null,
              name: null,
              outputIdentifire: null,
              resultId: null,
              categoryPathFieldId: null,
              isNotification: false,
              isPathResult: false,
              isPathValue: false
            }
          ],
          processOrder: 0
        }
      ],
      executeTrigger: {
        additionalProp1: false,
        additionalProp2: false,
        additionalProp3: false
      },
      executeIfCondetionGroup: [
        {
          id: null,
          relatedToCategoryPathFieldId: null,
          categoryPathFieldEventGroupId: null,
          conditionForId: null,
          andorOr: false,
          viewOrder: 0,
          conditions: [
            {
              id: null,
              fieldConditionGroupId: null,
              fieldId: null,
              conditionForId: null,
              conditionTypeId: null,
              value: null,
              andorOr: false,
              viewOrder: 0,
              valueList: [null],
              conditionRelationTypeId: null,
              categoryPathFieldRelatedEntityFieldId: null
            }
          ]
        }
      ],
      processOrder: 0,
      andorOr: false
    }
  ]
};








// import { Api_URL } from '../../Resources/ApiUrl';
// import LookUpsFrontdata from '../../Resources/LookUps'
// import  { useState ,useEffect } from "react";
// import styles from "./PathEditInfo.module.css";

// function PathEditInfo() {
//   const [groups, setGroups] = useState([{ id: 1, name: "Group 1", fields: [] }]);
//   const [openDropdownField, setOpenDropdownField] = useState(null);
//   const [activeField, setActiveField] = useState(null);
//   const [activeGroup, setActiveGroup] = useState(null);
//   const [activeTab, setActiveTab] = useState("main");
//   const inputFilterList = LookUpsFrontdata.FieldHelper;
//   const [fieldSelectList, setfieldSelectList] = useState(null);
//   const [chooseSelectField, setchooseSelectField] = useState(false);
// const [useCustomLookup, setUseCustomLookup] = useState(false);
// const [customOptions, setCustomOptions] = useState([]);
// const [newOption, setNewOption] = useState("");
//   // هذا ال-state يحتوى إعدادات الحقل (نستخدم عنصر واحد لكل فيلد عند الطلب)
//   const [groupFields, setgroupFields] = useState([
//     {
//       id: null,
//       name: "",
//       viewOrder: 0,
//       title: "",
//       type: "",
//       groupFields: 
//     [ {
//     id: null,
//     fieldTypeId: null,
//     name: "",
//     viewOrder: 0,
//     isReadOnly: false,
//     isRequired: false,
//     isReportExportable: false,
//     isForVisitReport: false,
//     isForSpecialSammaryReport: false,
//     title: "",
//     type: "",
//     unified: 0,
//     isOptionRelatedToEntity: false,
//     optionsRelatedToEntityId: null,
//     fieldOption: [          {
//               id: null,
//               name: "",
//               isActive: 0,
//               relatedCategoryPathFieldId: null,
//               relatedEntityOptionId: null,
//               relatedEntityId: null,
//               viewOrder: 0,
//               showIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: true,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: "",
//                       andorOr: true,
//                       viewOrder: 0,
//                       valueList: [],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               selectedIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: true,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: "",
//                       andorOr: true,
//                       viewOrder: 0,
//                       valueList: [],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               disabledIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: true,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: "",
//                       andorOr: true,
//                       viewOrder: 0,
//                       valueList: [],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ]
//             }],
//     showIfCondetionGroup: [],
//     readOnlyIfCondetionGroup: [],
//     disabledIfCondetionGroup: []
//   }] ,           showIfCondetionGroup: [
//             {
//               id: null,
//               relatedToCategoryPathFieldId: null,
//               categoryPathFieldEventGroupId: null,
//               conditionForId: null,
//               andorOr: true,
//               viewOrder: 0,
//               conditions: [
//                 {
//                   id: null,
//                   fieldConditionGroupId: null,
//                   fieldId: null,
//                   conditionForId: null,
//                   conditionTypeId: null,
//                   value: "",
//                   andorOr: true,
//                   viewOrder: 0,
//                   valueList: [],
//                   conditionRelationTypeId: null,
//                   categoryPathFieldRelatedEntityFieldId: null
//                 }
//               ]
//             }
//           ],
//           readOnlyIfCondetionGroup: [
//             {
//               id: null,
//               relatedToCategoryPathFieldId: null,
//               categoryPathFieldEventGroupId: null,
//               conditionForId: null,
//               andorOr: true,
//               viewOrder: 0,
//               conditions: [
//                 {
//                   id: null,
//                   fieldConditionGroupId: null,
//                   fieldId: null,
//                   conditionForId: null,
//                   conditionTypeId: null,
//                   value: "",
//                   andorOr: true,
//                   viewOrder: 0,
//                   valueList: [],
//                   conditionRelationTypeId: null,
//                   categoryPathFieldRelatedEntityFieldId: null
//                 }
//               ]
//             }
//           ],
//           disabledIfCondetionGroup: [
//             {
//               id: null,
//               relatedToCategoryPathFieldId: null,
//               categoryPathFieldEventGroupId: null,
//               conditionForId: null,
//               andorOr: true,
//               viewOrder: 0,
//               conditions: [
//                 {
//                   id: null,
//                   fieldConditionGroupId: null,
//                   fieldId: null,
//                   conditionForId: null,
//                   conditionTypeId: null,
//                   value: "",
//                   andorOr: true,
//                   viewOrder: 0,
//                   valueList: [],
//                   conditionRelationTypeId: null,
//                   categoryPathFieldRelatedEntityFieldId: null
//                 }
//               ]
//             }
//           ],
//                  eventsGroup: [
//             {
//               id: null,
//               events: [
//                 {
//                   id: null,
//                   actionTypeId: null,
//                   dynamicFunctionId: null,
//                   dynamicFunctionIdentifire: "",
//                   parameters: [
//                     {
//                       id: null,
//                       name: "",
//                       parameterIdentifire: "",
//                       parameterId: null,
//                       categoryPathFieldId: null,
//                       staticValue: "",
//                       isRelatedToPathFields: false,
//                       fieldShouldRelatedToEntityTypeId: null
//                     }
//                   ],
//                   results: [
//                     {
//                       id: null,
//                       name: "",
//                       outputIdentifire: "",
//                       resultId: null,
//                       categoryPathFieldId: null,
//                       isNotification: false,
//                       isPathResult: false,
//                       isPathValue: false
//                     }
//                   ],
//                   processOrder: 0
//                 }
//               ],
//               executeTrigger: {},
//               executeIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedToCategoryPathFieldId: null,
//                   categoryPathFieldEventGroupId: null,
//                   conditionForId: null,
//                   andorOr: true,
//                   viewOrder: 0,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldConditionGroupId: null,
//                       fieldId: null,
//                       conditionForId: null,
//                       conditionTypeId: null,
//                       value: "",
//                       andorOr: true,
//                       viewOrder: 0,
//                       valueList: [],
//                       conditionRelationTypeId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               andorOr: true,
//               processOrder: 0
//             }
//           ]}]);

//   // --- جديد: حالات لاستخدام خيارات من كيان النظام وجلب بياناته ---
//   const [useSystemLookup, setUseSystemLookup] = useState(false); // تم تفعيل خيار استخدام كيانات النظام
//   const [selectedSystemLookupKey, setSelectedSystemLookupKey] = useState(""); // ال-key المختار من ApplicationLookUp
//   const [systemLookupItems, setSystemLookupItems] = useState([]); // النتيجة الراجعة من ال-API
//   const [systemLookupLoading, setSystemLookupLoading] = useState(false);
// const [conditionsList, setConditionsList] = useState([]); // كل الشروط المضافة
// const [conditionTypes, setConditionTypes] = useState([]); // أنواع الشروط من API
//   // وظيفة مساعدة بسيطة لتفادي أخطاء auto-resize إذا كانت مفقودة

//   const [disableConditionsList, setDisableConditionsList] = useState([]);

//   const autoResize = (e) => {
//     if (!e || !e.target) return;
//     try {
//       e.target.style.height = "auto";
//       e.target.style.height = `${e.target.scrollHeight}px`;
//     } catch (err) { /* noop */ }
//   };

//   useEffect(() => {
//     if (!activeField) return;

//     const updatedGroup = groups.find((g) =>
//       g.fields.some((f) => f.id === activeField.id)
//     );
//     if (!updatedGroup) return;

//     const updatedField = updatedGroup.fields.find(
//       (f) => f.id === activeField.id
//     );

//     if (updatedField && updatedField.label !== activeField.label) {
//       setActiveField(updatedField);
//     }
//   }, [groups]);

//   // --- تأكد أن لدينا إعدادات (groupFields) مدفوعة بالفيلد النشط حتى نستطيع تعديل نوعه بسهولة ---
//   useEffect(() => {
//     if (!activeField) return;
//     setgroupFields((prev) => {
//       const exists = prev.some((p) => p.id === activeField.id);
//       if (exists) return prev;
//       // clone من القالب الأول لكن نعطيه id واسم مرتبطين بالفيلد النشط
//       const template = prev[0] || {
//         id: activeField.id,
//         fieldTypeId: null,
//         name: activeField.label || "",
//         title: activeField.label || "",
//       };
//       return [...prev, { ...template, id: activeField.id, name: activeField.label || '', title: activeField.label || '' }];
//     });
//   }, [activeField]);

//   useEffect(() => {
//   const fetchConditionTypes = async () => {
//     try {
//       const entity = LookUpsFrontdata.ApplicationLookUp.find(
//         (e) => e.value === "أنواع الشروط"
//       );
//       if (!entity) return;

//       const dto = { entityId: entity.key, condetion: null };
//       const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
//         method: "POST",
//         headers: { "Content-Type": "application/json" },
//         body: JSON.stringify(dto),
//       });
//       const data = await res.json();

//       if (data?.succeeded && data?.data?.items) {
//         setConditionTypes(data.data.items.map(c => ({ value: c.value, text: c.text })));
//       }
//     } catch (err) {
//       console.error(err);
//     }
//   };

//   fetchConditionTypes();
// }, []);


//   let HandleFieldTypeSelect = (e) => {
//     const selectedValue = e.target.value;   // value من الـ option
//     const selectedText = e.target.options[e.target.selectedIndex].text; // النص الظاهر

//     if (selectedText === "One Select" || selectedText === "MultibelSelect" || selectedText === "خيارات متعددة (Select)" || selectedText === "اختيار واحد (Select)") {
//       setchooseSelectField(true);
//     } else {
//       setchooseSelectField(false);
//     }

//     setgroupFields((prev) =>
//       prev.map((field) =>
//         field.id === activeField?.id
//           ? { ...field, fieldTypeId: selectedValue, type: selectedText }
//           : field
//       )
//     );

//   }

//   useEffect(() => {
//     const fetchFieldTypes = async () => {
//       try {
//         const entity = LookUpsFrontdata.ApplicationLookUp.find(
//           (e) => e.value === "أنواع الحقول"
//         );

//         if (!entity) return;

//         const dto = {
//           entityId: entity.key,
//           condetion: null,
//         };

//         const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
//           method: "POST",
//           headers: { "Content-Type": "application/json" },
//           body: JSON.stringify(dto),
//         });

//         const data = await res.json();

//         if (data?.succeeded && data?.data?.items) {
//           const mapped = data.data.items.map((c) => ({
//             value: c.value,
//             text: c.text,
//           }));
//           setfieldSelectList(mapped);
//         }
//       } catch (err) {
//         console.error(err);
//         if (typeof toast !== 'undefined') {
//           toast.error("خطأ فالتحميل", {
//             position: "top-right",
//             style: { backgroundColor: "red", color: "white" },
//           });
//         }
//       }
//     };

//     fetchFieldTypes();
//   }, []);

//   // --- جديد: عندما يختار المستخدم كيان من ApplicationLookUp نجيب منه بيانات الـ Lookup ---
//   useEffect(() => {
//     if (!selectedSystemLookupKey) {
//       setSystemLookupItems([]);
//       return;
//     }

//     const fetchSystemLookupItems = async () => {
//       setSystemLookupLoading(true);
//       try {
//         const dto = { entityId: selectedSystemLookupKey, condetion: null };
//         const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
//           method: 'POST',
//           headers: { 'Content-Type': 'application/json' },
//           body: JSON.stringify(dto),
//         });
//         const data = await res.json();
//         if (data?.succeeded && data?.data?.items) {
//           // نحفظ الـ items عشان نعرضهم في ال-list (نأخذ text و value من كل item)
//           setSystemLookupItems(data.data.items.map(it => ({ text: it.text ?? it.value, value: it.value })));
//         } else {
//           setSystemLookupItems([]);
//         }
//       } catch (err) {
//         console.error(err);
//         setSystemLookupItems([]);
//         if (typeof toast !== 'undefined') {
//           toast.error("خطأ في جلب بيانات الـ Lookup");
//         }
//       } finally {
//         setSystemLookupLoading(false);
//       }
//     };

//     fetchSystemLookupItems();
//   }, [selectedSystemLookupKey]);



//   const addCondition = () => {
//   setConditionsList(prev => [
//     ...prev,
//     { id: Date.now(), fieldId: "", conditionTypeId: "", value: "" }
//   ]);
// };

// const addDisableCondition = () => {
//   setDisableConditionsList(prev => [
//     ...prev,
//     { id: Date.now(), fieldId: "", conditionTypeId: "", value: "" }
//   ]);
// };
//   // إضافة جروب
//   const addGroup = () => {
//     setGroups((prev) => [
//       ...prev,
//       { id: Date.now(), name: `Group ${prev.length + 1}`, fields: [] },
//     ]);
//   };

//   // تعديل اسم الجروب
//   const handleGroupNameChange = (groupId, newName) => {
//     setGroups((prev) =>
//       prev.map((g) => (g.id === groupId ? { ...g, name: newName } : g))
//     );
//   };

//   // إضافة فيلد
//   const addField = () => {
//     setGroups((prev) => {
//       if (prev.length === 0) {
//         const newGroup = { id: Date.now(), name: "Group 1", fields: [] };
//         newGroup.fields.push({ id: Date.now() + 1, label: "Field 1" });
//         return [newGroup];
//       }
//       return prev.map((g, idx) =>
//         idx === 0
//           ? { ...g, fields: [...g.fields, { id: Date.now(), label: `Field ${g.fields.length + 1}` }] }
//           : g
//       );
//     });
//   };

//   const handleFieldLabelChange = (groupId, fieldId, newLabel) => {
//     setGroups((prev) =>
//       prev.map((g) =>
//         g.id === groupId
//           ? {
//               ...g,
//               fields: g.fields.map((f) =>
//                 f.id === fieldId ? { ...f, label: newLabel } : f
//               ),
//             }
//           : g
//       )
//     );

//     setActiveField((af) => {
//       if (!af) {
//         return { id: fieldId, label: newLabel };
//       }
//       if (af.id === fieldId) {
//         return { ...af, label: newLabel };
//       }
//       return af;
//     });
//   };

//   // Drag Start
//   const handleDragStart = (e, fieldId, fromGroupId) => {
//     const payload = JSON.stringify({ fieldId, fromGroupId });
//     e.dataTransfer.setData("text/plain", payload);
//     e.dataTransfer.effectAllowed = "move";
//   };

//   // Drop
//   const handleDrop = (e, targetGroupId) => {
//     e.preventDefault();
//     const raw = e.dataTransfer.getData("text/plain");
//     if (!raw) return;
//     let obj;
//     try {
//       obj = JSON.parse(raw);
//     } catch {
//       return;
//     }
//     const { fieldId, fromGroupId } = obj;
//     if (fromGroupId === targetGroupId) return;

//     setGroups((prev) => {
//       let fieldObj = null;
//       const removed = prev.map((g) => {
//         if (g.id === fromGroupId) {
//           const filtered = g.fields.filter((f) => {
//             if (f.id === fieldId) {
//               fieldObj = f;
//               return false;
//             }
//             return true;
//           });
//           return { ...g, fields: filtered };
//         }
//         return g;
//       });
//       if (!fieldObj) return prev;
//       return removed.map((g) =>
//         g.id === targetGroupId ? { ...g, fields: [...g.fields, fieldObj] } : g
//       );
//     });
//   };

//   // حذف جروب
//   const deleteGroup = (groupId) => {
//     setGroups((prev) => prev.filter((g) => g.id !== groupId));
//   };

//   // حذف فيلد
//   const deleteField = (groupId, fieldId) => {
//     setGroups((prev) =>
//       prev.map((g) =>
//         g.id === groupId ? { ...g, fields: g.fields.filter((f) => f.id !== fieldId) } : g
//       )
//     );
//     setActiveField((af) => (af && af.id === fieldId ? null : af));
//   };

//   // currentGroupField للمساعدة عند عرض select نوع الحقل
//   const currentGroupField = groupFields.find(f => f.id === activeField?.id) || groupFields[0];

//   return (
//     <div className={styles.container}>
//       {/* العمود الشمال */}
//       <div className={styles.left}>
//         <div className={styles.groupsPanel}>
//           <div className={styles.actions}>
//             <button onClick={addGroup} className={styles.addButton}>+ New Group</button>
//             <button onClick={addField} className={styles.addButton}>+ New Field</button>
//           </div>

//           <div className={styles.groupsList}>
//             {groups.map((group) => (
//               <div
//                 key={group.id}
//                 className={styles.groupBox}
//                 onDragOver={(e) => e.preventDefault()}
//                 onDrop={(e) => handleDrop(e, group.id)}
//               >
//                 <div className={styles.groupHeader}>
//                   <input
//                     type="text"
//                     value={group.name}
//                     onChange={(e) => {handleGroupNameChange(group.id, e.target.value); autoResize(e);} }
//                     className={styles.groupNameInput}
//                     onClick={() => setActiveGroup(group)}
//                   />
//                   <button className={styles.deleteBtn} onClick={() => deleteGroup(group.id)}><i className="bi bi-trash-fill fs-3"></i></button>
//                 </div>

//                 <ul className={styles.fieldsUl}>
//                   {group.fields.map((field) => (
//                     <li
//                       key={field.id}
//                       className={styles.fieldItem}
//                       draggable
//                       onDragStart={(e) => handleDragStart(e, field.id, group.id)}
//                        onClick={() => {
//     setOpenDropdownField(null);
//   setActiveField(field);
//   }}
//                     >
//                       <span className={styles.dragHandle} aria-hidden>≡</span>
//                        <div className={styles.fieldWithDropdown}>
//                       <input
//                         type="text"
//                         value={field.label}
//                         onChange={(e) => {handleFieldLabelChange(group.id, field.id, e.target.value);  
//                           autoResize(e);
//                          setOpenDropdownField(field.id);
//                         } }
//                         className={styles.fieldInput}
//                         draggable={false}
//                       />
//                             {/* suggestions */}
//       {openDropdownField === field.id && field.label && (
//         <ul className={styles.suggestions}>
//           {inputFilterList
//             .filter((item) =>
//               item.value.toLowerCase().includes(field.label.toLowerCase())
//             )
//             .map((item) => (
//               <li
//                 key={item.key}
//                 onClick={() =>{handleFieldLabelChange(group.id, field.id, item.value); 
//                   setOpenDropdownField(null);} }
//                 className={styles.suggestionItem}
//               >
//                 {item.value}
//               </li>
//             ))}
//         </ul>
//       )}
//     </div>
//                       <button
//                         className={styles.deleteBtn}
//                         onClick={(e) => {
//                           e.stopPropagation();
//                           deleteField(group.id, field.id);
//                         }}
//                       >❌</button>
//                     </li>
//                   ))}
//                 </ul>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>

//       {/* العمود اليمين */}
//      {activeField ? (  <div className={styles.right}>
//         <> <div className={styles.navbar}>
//           <button className={activeTab === "main" ? styles.activeBtn : ""} onClick={() => setActiveTab("main")}>
//             الصفحة الرئيسية
//             </button>
//           <button className={activeTab === "fieldOptions" ? styles.activeBtn : ""} onClick={() => setActiveTab("fieldOptions")}>
//             خيارات الحقل
//             </button>
//           <button className={activeTab === "conditions" ? styles.activeBtn : ""} onClick={() => setActiveTab("conditions")}>شروط الإظهار</button>
//              <button
//       className={activeTab === "disableConditions" ? styles.activeBtn : ""}
//       onClick={() => setActiveTab("disableConditions")}
//     >
//       شروط التعطيل
//     </button>
//         </div>

//         <div className={styles.tabContent}>
//           {activeTab === "main" && (
//             <div>
//               <p>العنوان</p>
//               <input
//                 type="text"
//                 className={styles.input}
//                 value={activeField ? activeField.label : ""}
//               />
//               <p className='mt-2'>النوع</p>
//             <select className={styles.input} value={currentGroupField?.fieldTypeId ?? ""} onChange={HandleFieldTypeSelect}>
//   <option value="">اختر نوع الحقل</option>
//   {fieldSelectList?.map((e) => (
//     <option value={e.value} key={e.value}>
//       {e.text}
//     </option>
//   ))}
// </select>

//                   <div className={`mt-3 ${styles.checkboxGroup}`}>
//       <label>
//         <input type="checkbox" />
//         هل الحقل إجباري عند ظهور المسار؟
//       </label>
//       <br />
//       <label>
//         <input type="checkbox" />
//         هل الحقل للقراءة فقط؟
//       </label>
//       <br />
//            <label>
//         <input type="checkbox" />
//         هل الحقل قابل للتصدير فالتقارير؟
//       </label>
//     </div>

//             </div>
//           )}
//           {activeTab === "fieldOptions" && <div >{chooseSelectField?
//           <div className='container'>
//             <h4>فقط اختر نوع من انواع النظام</h4>
// <div className='row'>
// <div className='col-6'> <label>
//         <input   type="radio"
//       name="lookupOption"  
//       checked={useSystemLookup}
//       onChange={() => {
//         setUseSystemLookup(true);
//         setSelectedSystemLookupKey('');
//         setSystemLookupItems([]);
//       }} />
//      خيارات من كيان النظام 
//       </label></div>
// <div className='col-6'> 
//   <label>
//         <input   type="radio"
//       name="lookupOption"   
//       checked={!useSystemLookup}
//       onChange={() => {
//         setUseSystemLookup(false);
//         setSelectedSystemLookupKey('');
//         setSystemLookupItems([]);
//       }} />
//     خيارات مخصصه
//            </label>
// </div>
// <br />

// {/* لو تم تفعيل استخدام كيانات النظام نعرض select مملوء من LookUpsFrontdata.ApplicationLookUp */}
// {useSystemLookup && (
//   <div className='col-12 mt-2'>
//     <label>اختر كيان من بيان النظام</label>
//     <select className='form-control mt-2' value={selectedSystemLookupKey} onChange={(e)=>setSelectedSystemLookupKey(e.target.value)}>
//       <option value="">-- اختر --</option>
//       {LookUpsFrontdata.ApplicationLookUp.map(item => (
//         <option key={item.key} value={item.key}>{item.value}</option>
//       ))}
//     </select>

//     {/* بعد الاختيار نعرض بيانات ال-lookup الراجعة */}
//     <div className='mt-2'>
//       {systemLookupLoading ? (
//         <div>جاري التحميل ...</div>
//       ) : (
//         <div className={styles.listScroll}>
//           {systemLookupItems.length === 0 ? (
//             <div className='text-muted'>لا توجد بيانات</div>
//           ) : (
//             systemLookupItems.map((it, idx) => (
//               <div key={idx} className='list-group-item'>
//                 <strong>{it.text}</strong>
//                   <button
//               className='btn btn-sm  ms-3'
//               onClick={() => {
//                 setSystemLookupItems(prev => prev.filter((_, i) => i !== idx));
//               }}
//             >
//               🗑
//             </button>
//               </div>
//             ))
//           )}
//         </div>
//       )}
//     </div>
//   </div>
// )}
//  {customOptions.length === 0 ? (
// <></>
//       ) : (<div className={`col-12 container ${styles.listScroll} mt-3`}>{
//         customOptions.map((it, idx) => (
//           <div key={idx} className={`list-item-group `}>
//             <strong>{it.text}</strong>
//             <button
//               className="btn btn-sm  ms-3"
//               onClick={() =>
//                 setCustomOptions((prev) => prev.filter((_, i) => i !== idx))
//               }
//             >
//               🗑
//             </button>
//           </div>
//         ))}
//          </div>
//       )}
// <input type="text" placeholder=' اضافة خيار جديد' className={styles.input}   value={newOption}
//   onChange={(e) => setNewOption(e.target.value)} />
// <button className='btn btn-primary mt-2'  onClick={() => {
//         if (newOption.trim()) {
//           setCustomOptions((prev) => [...prev, { text: newOption, value: newOption }]);
//           setNewOption("");
//         }
//       }}>اضافه</button>
// </div>
//           </div>
          
          
          
//           :"لا يوجد اختيارات لهذا الحقل"}</div>}
// {activeTab === "conditions" && (
//   <div>
//     <button className="btn btn-primary mb-2" onClick={addCondition}>
//       + اضف شرط
//     </button>

//     {conditionsList.map((cond, idx) => (
//       <div key={cond.id} className="card p-2 mb-2">
//         {/* اختيار الفيلد */}
//         <select
//           className="form-control mb-2"
//           value={cond.fieldId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, fieldId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر الفيلد</option>
//           {groups.flatMap(g => g.fields).map(f => (
//             <option key={f.id} value={f.id}>{f.label}</option>
//           ))}
//         </select>

//         {/* اختيار نوع الشرط */}
//         <select
//           className="form-control mb-2"
//           value={cond.conditionTypeId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, conditionTypeId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر نوع الشرط</option>
//           {conditionTypes.map(ct => (
//             <option key={ct.value} value={ct.value}>{ct.text}</option>
//           ))}
//         </select>

//         {/* لو الشرط من النوع اللي محتاج قيمة */}
//         {/* {!(cond.conditionTypeId === "فارغ" || cond.conditionTypeId === "غير فارغ"||cond.conditionTypeId ==="Not Null"||
//           cond.conditionTypeId ==="Null" )&& (
//           <input
//             type="text"
//             className="form-control"
//             placeholder="ادخل القيمة"
//             value={cond.value}
//             onChange={(e) => {
//               const val = e.target.value;
//               setConditionsList(prev =>
//                 prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//               );
//             }}
//           />
//         )} */}
//         {(() => {
//   const selectedConditionType = conditionTypes.find(ct => ct.value === cond.conditionTypeId);
//   const conditionText = selectedConditionType?.text;

//   return !(conditionText === "فارغ" || conditionText === "غير فارغ" || conditionText === "Not Null" || conditionText === "Null") && (
//     <input
//       type="text"
//       className="form-control"
//       placeholder="ادخل القيمة"
//       value={cond.value}
//       onChange={(e) => {
//         const val = e.target.value;
//         setConditionsList(prev =>
//           prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//         );
//       }}
//     />
//   );
// })()}
//       </div>
//     ))}
//   </div>
// )}

//             {activeTab === "disableConditions" && (
//   <div>
//     <button className="btn btn-primary mb-2" onClick={addDisableCondition}>
//       + اضف شرط تعطيل
//     </button>

//     {disableConditionsList.map((cond, idx) => (
//       <div key={cond.id} className="card p-2 mb-2">
//         <select
//           className="form-control mb-2"
//           value={cond.fieldId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setDisableConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, fieldId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر الفيلد</option>
//           {groups.flatMap(g => g.fields).map(f => (
//             <option key={f.id} value={f.id}>{f.label}</option>
//           ))}
//         </select>

//         <select
//           className="form-control mb-2"
//           value={cond.conditionTypeId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setDisableConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, conditionTypeId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر نوع الشرط</option>
//           {conditionTypes.map(ct => (
//             <option key={ct.value} value={ct.value}>{ct.text}</option>
//           ))}
//         </select>

//         {/* {!(cond.conditionTypeId === "فارغ" || cond.conditionTypeId === "غير فارغ"||cond.conditionTypeId ==="Not Null"||
//           cond.conditionTypeId ==="Null" ) && (
//           <input
//             type="text"
//             className="form-control"
//             placeholder="ادخل القيمة"
//             value={cond.value}
//             onChange={(e) => {
//               const val = e.target.value;
//               setDisableConditionsList(prev =>
//                 prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//               );
//             }}
//           />
//         )} */}
//         {(() => {
//   const selectedConditionType = conditionTypes.find(ct => ct.value === cond.conditionTypeId);
//   const conditionText = selectedConditionType?.text;

//   return !(conditionText === "فارغ" || conditionText === "غير فارغ" || conditionText === "Not Null" || conditionText === "Null") && (
//     <input
//       type="text"
//       className="form-control"
//       placeholder="ادخل القيمة"
//       value={cond.value}
//       onChange={(e) => {
//         const val = e.target.value;
//         setDisableConditionsList(prev =>
//           prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//         );
//       }}
//     />
//   );
// })()}

//       </div>
//     ))}
//   </div>
// )}

//         </div></>

//       </div>):null} 
//     </div>
//   );
// }

// export default PathEditInfo;




















// import { v4 as uuidv4 } from "uuid";
// import { Api_URL } from '../../Resources/ApiUrl';
// import LookUpsFrontdata from '../../Resources/LookUps'
// import  { useState ,useEffect } from "react";
// import styles from "./PathEditInfo.module.css";

// function PathEditInfo() {
//   const [groups, setGroups] = useState([{ id: 1, name: "Group 1", fields: [] }]);
//   const [openDropdownField, setOpenDropdownField] = useState(null);
//   const [activeField, setActiveField] = useState(null);
//   const [activeGroup, setActiveGroup] = useState(null);
//   const [activeTab, setActiveTab] = useState("main");
//   const inputFilterList = LookUpsFrontdata.FieldHelper;
//   const [fieldSelectList, setfieldSelectList] = useState(null);
//   const [chooseSelectField, setchooseSelectField] = useState(false);
// const [useCustomLookup, setUseCustomLookup] = useState(false);
// const [customOptions, setCustomOptions] = useState([]);
// const [newOption, setNewOption] = useState("");
//   // هذا ال-state يحتوى إعدادات الحقل (نستخدم عنصر واحد لكل فيلد عند الطلب)
//   const [pathGroups, setPathGroups] = useState([
//     {
//       id: null,
//       name: "",
//       viewOrder: 0,
//       title: "",
//       type: "",
//       groupFields: 
//     [ {
//     id: null,
//     fieldTypeId: null,
//     name: "",
//     viewOrder: 0,
//     isReadOnly: false,
//     isRequired: false,
//     isReportExportable: false,
//     isForVisitReport: false,
//     isForSpecialSammaryReport: false,
//     title: "",
//     type: "",
//     unified: 0,
//     isOptionRelatedToEntity: false,
//     optionsRelatedToEntityId: null,
//     fieldOption: [          {
//               id: null,
//               name: "",
//               isActive: 0,
//               relatedCategoryPathFieldId: null,
//               relatedEntityOptionId: null,
//               relatedEntityId: null,
//               viewOrder: 0,
//               showIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: true,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: "",
//                       andorOr: true,
//                       viewOrder: 0,
//                       valueList: [],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               selectedIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: true,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: "",
//                       andorOr: true,
//                       viewOrder: 0,
//                       valueList: [],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               disabledIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: true,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: "",
//                       andorOr: true,
//                       viewOrder: 0,
//                       valueList: [],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ]
//             }],
//     showIfCondetionGroup: [],
//     readOnlyIfCondetionGroup: [],
//     disabledIfCondetionGroup: []
//   }] ,  
//                  eventsGroup: [
//             {
//               id: null,
//               events: [
//                 {
//                   id: null,
//                   actionTypeId: null,
//                   dynamicFunctionId: null,
//                   dynamicFunctionIdentifire: "",
//                   parameters: [
//                     {
//                       id: null,
//                       name: "",
//                       parameterIdentifire: "",
//                       parameterId: null,
//                       categoryPathFieldId: null,
//                       staticValue: "",
//                       isRelatedToPathFields: false,
//                       fieldShouldRelatedToEntityTypeId: null
//                     }
//                   ],
//                   results: [
//                     {
//                       id: null,
//                       name: "",
//                       outputIdentifire: "",
//                       resultId: null,
//                       categoryPathFieldId: null,
//                       isNotification: false,
//                       isPathResult: false,
//                       isPathValue: false
//                     }
//                   ],
//                   processOrder: 0
//                 }
//               ],
//               executeTrigger: {},
//               executeIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedToCategoryPathFieldId: null,
//                   categoryPathFieldEventGroupId: null,
//                   conditionForId: null,
//                   andorOr: true,
//                   viewOrder: 0,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldConditionGroupId: null,
//                       fieldId: null,
//                       conditionForId: null,
//                       conditionTypeId: null,
//                       value: "",
//                       andorOr: true,
//                       viewOrder: 0,
//                       valueList: [],
//                       conditionRelationTypeId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               andorOr: true,
//               processOrder: 0
//             }
//           ]}]);

//   // --- جديد: حالات لاستخدام خيارات من كيان النظام وجلب بياناته ---
//   const [useSystemLookup, setUseSystemLookup] = useState(false); // تم تفعيل خيار استخدام كيانات النظام
//   const [selectedSystemLookupKey, setSelectedSystemLookupKey] = useState(""); // ال-key المختار من ApplicationLookUp
//   const [systemLookupItems, setSystemLookupItems] = useState([]); // النتيجة الراجعة من ال-API
//   const [systemLookupLoading, setSystemLookupLoading] = useState(false);
// const [conditionsList, setConditionsList] = useState([]); // كل الشروط المضافة
// const [conditionTypes, setConditionTypes] = useState([]); // أنواع الشروط من API
//   // وظيفة مساعدة بسيطة لتفادي أخطاء auto-resize إذا كانت مفقودة

//   const [disableConditionsList, setDisableConditionsList] = useState([]);

//   const autoResize = (e) => {
//     if (!e || !e.target) return;
//     try {
//       e.target.style.height = "auto";
//       e.target.style.height = `${e.target.scrollHeight}px`;
//     } catch (err) { /* noop */ }
//   };

//   useEffect(() => {
//     if (!activeField) return;

//     const updatedGroup = groups.find((g) =>
//       g.fields.some((f) => f.id === activeField.id)
//     );
//     if (!updatedGroup) return;

//     const updatedField = updatedGroup.fields.find(
//       (f) => f.id === activeField.id
//     );

//     if (updatedField && updatedField.label !== activeField.label) {
//       setActiveField(updatedField);
//     }
//   }, [groups]);

//   // --- تأكد أن لدينا إعدادات (groupFields) مدفوعة بالفيلد النشط حتى نستطيع تعديل نوعه بسهولة ---
//   useEffect(() => {
//     if (!activeField) return;
//     setgroupFields((prev) => {
//       const exists = prev.some((p) => p.id === activeField.id);
//       if (exists) return prev;
//       // clone من القالب الأول لكن نعطيه id واسم مرتبطين بالفيلد النشط
//       const template = prev[0] || {
//         id: activeField.id,
//         fieldTypeId: null,
//         name: activeField.label || "",
//         title: activeField.label || "",
//       };
//       return [...prev, { ...template, id: activeField.id, name: activeField.label || '', title: activeField.label || '' }];
//     });
//   }, [activeField]);

//   useEffect(() => {
//   const fetchConditionTypes = async () => {
//     try {
//       const entity = LookUpsFrontdata.ApplicationLookUp.find(
//         (e) => e.value === "أنواع الشروط"
//       );
//       if (!entity) return;

//       const dto = { entityId: entity.key, condetion: null };
//       const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
//         method: "POST",
//         headers: { "Content-Type": "application/json" },
//         body: JSON.stringify(dto),
//       });
//       const data = await res.json();

//       if (data?.succeeded && data?.data?.items) {
//         setConditionTypes(data.data.items.map(c => ({ value: c.value, text: c.text })));
//       }
//     } catch (err) {
//       console.error(err);
//     }
//   };

//   fetchConditionTypes();
// }, []);


//   let HandleFieldTypeSelect = (e) => {
//     const selectedValue = e.target.value;   // value من الـ option
//     const selectedText = e.target.options[e.target.selectedIndex].text; // النص الظاهر

//     if (selectedText === "One Select" || selectedText === "MultibelSelect" || selectedText === "خيارات متعددة (Select)" || selectedText === "اختيار واحد (Select)") {
//       setchooseSelectField(true);
//     } else {
//       setchooseSelectField(false);
//     }

//     setgroupFields((prev) =>
//       prev.map((field) =>
//         field.id === activeField?.id
//           ? { ...field, fieldTypeId: selectedValue, type: selectedText }
//           : field
//       )
//     );

//       setgroupFields(prev =>
//     prev.map(g => ({
//       ...g,
//       groupFields: g.groupFields.map(f =>
//         f.id === activeField?.id
//           ? { ...f, fieldTypeId: selectedValue, type: selectedText }
//           : f
//       )
//     }))
//   );

//   }

//   useEffect(() => {
//     const fetchFieldTypes = async () => {
//       try {
//         const entity = LookUpsFrontdata.ApplicationLookUp.find(
//           (e) => e.value === "أنواع الحقول"
//         );

//         if (!entity) return;

//         const dto = {
//           entityId: entity.key,
//           condetion: null,
//         };

//         const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
//           method: "POST",
//           headers: { "Content-Type": "application/json" },
//           body: JSON.stringify(dto),
//         });

//         const data = await res.json();

//         if (data?.succeeded && data?.data?.items) {
//           const mapped = data.data.items.map((c) => ({
//             value: c.value,
//             text: c.text,
//           }));
//           setfieldSelectList(mapped);
//         }
//       } catch (err) {
//         console.error(err);
//         if (typeof toast !== 'undefined') {
//           toast.error("خطأ فالتحميل", {
//             position: "top-right",
//             style: { backgroundColor: "red", color: "white" },
//           });
//         }
//       }
//     };

//     fetchFieldTypes();
//   }, []);

//   // --- جديد: عندما يختار المستخدم كيان من ApplicationLookUp نجيب منه بيانات الـ Lookup ---
//   useEffect(() => {
//     if (!selectedSystemLookupKey) {
//       setSystemLookupItems([]);
//       return;
//     }

//     const fetchSystemLookupItems = async () => {
//       setSystemLookupLoading(true);
//       try {
//         const dto = { entityId: selectedSystemLookupKey, condetion: null };
//         const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
//           method: 'POST',
//           headers: { 'Content-Type': 'application/json' },
//           body: JSON.stringify(dto),
//         });
//         const data = await res.json();
//         if (data?.succeeded && data?.data?.items) {
//           // نحفظ الـ items عشان نعرضهم في ال-list (نأخذ text و value من كل item)
//           setSystemLookupItems(data.data.items.map(it => ({ text: it.text ?? it.value, value: it.value })));
//         } else {
//           setSystemLookupItems([]);
//         }
//       } catch (err) {
//         console.error(err);
//         setSystemLookupItems([]);
//         if (typeof toast !== 'undefined') {
//           toast.error("خطأ في جلب بيانات الـ Lookup");
//         }
//       } finally {
//         setSystemLookupLoading(false);
//       }
//     };

//     fetchSystemLookupItems();
//   }, [selectedSystemLookupKey]);



//   const addCondition = () => {
//   setConditionsList(prev => [
//     ...prev,
//     { id: Date.now(), fieldId: "", conditionTypeId: "", value: "" }
//   ]);
// };

// const addDisableCondition = () => {
//   setDisableConditionsList(prev => [
//     ...prev,
//     { id: Date.now(), fieldId: "", conditionTypeId: "", value: "" }
//   ]);
// };
//   // إضافة جروب
//   const addGroup = () => {
// const newGroup = {
//     id: uuidv4(),
//     name: `Group ${groups.length + 1}`,
//     viewOrder: groups.length,
//     title: `Group ${groups.length + 1}`,
//     type: "group",
//     groupFields: []
//   };

//   setGroups(prev => [...prev, { id: newGroup.id, name: newGroup.name, fields: [] }]);

//   // for backend
//   setPathGroups(prev => [...prev, newGroup]);

//   };

//   // تعديل اسم الجروب
//   const handleGroupNameChange = (groupId, newName) => {
//     setGroups((prev) =>
//       prev.map((g) => (g.id === groupId ? { ...g, name: newName } : g))
//     );
//       // for backend
//   setPathGroups(prev => [...prev, newGroup]);
//   };

//   // إضافة فيلد
//   const addField = () => {
//     const newField = {
//     id: uuidv4(),
//     fieldTypeId: null,
//     name: `Field ${Date.now()}`, 
//     title: `Field ${Date.now()}`,
//     type: "",
//     isReadOnly: false,
//     isRequired: false,
//     isReportExportable: false,
//     isForVisitReport: false,
//     isForSpecialSammaryReport: false,
//     viewOrder: 0,
//     fieldOption: []
//   };
//       setGroups(prev =>
//     prev.map(g =>
//       g.id === groupId ? { ...g, fields: [...g.fields, { id: newField.id, label: newField.name }] } : g
//     )
//   );

// // forbackend
//   setPathGroups(prev =>
//     prev.map(g =>
//       g.id === groupId
//         ? { ...g, groupFields: [...g.groupFields, newField] }
//         : g
//     )
//   );

//   };

//   const handleFieldLabelChange = (groupId, fieldId, newLabel) => {
//     setGroups((prev) =>
//       prev.map((g) =>
//         g.id === groupId
//           ? {
//               ...g,
//               fields: g.fields.map((f) =>
//                 f.id === fieldId ? { ...f, label: newLabel } : f
//               ),
//             }
//           : g
//       )
//     );

//     setActiveField((af) => {
//       if (!af) {
//         return { id: fieldId, label: newLabel };
//       }
//       if (af.id === fieldId) {
//         return { ...af, label: newLabel };
//       }
//       return af;
//     });

// //for back 
//  setPathGroups((prev) =>
//     prev.map((g) =>
//       g.id === groupId
//         ? {
//             ...g,
//             groupFields: g.groupFields.map((f) =>
//               f.id === fieldId ? { ...f, title: newLabel, name: newLabel } : f
//             ),
//           }
//         : g
//     )
//   );
//   };

//   // Drag Start
//   const handleDragStart = (e, fieldId, fromGroupId) => {
//     const payload = JSON.stringify({ fieldId, fromGroupId });
//     e.dataTransfer.setData("text/plain", payload);
//     e.dataTransfer.effectAllowed = "move";
//   };

//   // Drop
//   const handleDrop = (e, targetGroupId) => {
//     e.preventDefault();
//     const raw = e.dataTransfer.getData("text/plain");
//     if (!raw) return;
//     let obj;
//     try {
//       obj = JSON.parse(raw);
//     } catch {
//       return;
//     }
//     const { fieldId, fromGroupId } = obj;
//     if (fromGroupId === targetGroupId) return;

//     setGroups((prev) => {
//       let fieldObj = null;
//       const removed = prev.map((g) => {
//         if (g.id === fromGroupId) {
//           const filtered = g.fields.filter((f) => {
//             if (f.id === fieldId) {
//               fieldObj = f;
//               return false;
//             }
//             return true;
//           });
//           return { ...g, fields: filtered };
//         }
//         return g;
//       });
//       if (!fieldObj) return prev;
//       return removed.map((g) =>
//         g.id === targetGroupId ? { ...g, fields: [...g.fields, fieldObj] } : g
//       );
//     });
//     // for back

//      setPathGroups((prev) => {
//     let fieldObj = null;
//     const removed = prev.map((g) => {
//       if (g.id === fromGroupId) {
//         const filtered = g.groupFields.filter((f) => {
//           if (f.id === fieldId) {
//             fieldObj = f;
//             return false;
//           }
//           return true;
//         });
//         return { ...g, groupFields: filtered };
//       }
//       return g;
//     });
//     if (!fieldObj) return prev;
//     return removed.map((g) =>
//       g.id === targetGroupId
//         ? { ...g, groupFields: [...g.groupFields, fieldObj] }
//         : g
//     );
//   });
//   };

//   // حذف جروب
//   const deleteGroup = (groupId) => {
//     setGroups((prev) => prev.filter((g) => g.id !== groupId));
//     // for back
//       setPathGroups((prev) => prev.filter((g) => g.id !== groupId));
//   };

//   // حذف فيلد
//   const deleteField = (groupId, fieldId) => {
//     setGroups((prev) =>
//       prev.map((g) =>
//         g.id === groupId ? { ...g, fields: g.fields.filter((f) => f.id !== fieldId) } : g
//       )
//     );
//     setActiveField((af) => (af && af.id === fieldId ? null : af));

//     // for back
//      setPathGroups((prev) =>
//     prev.map((g) =>
//       g.id === groupId
//         ? { ...g, groupFields: g.groupFields.filter((f) => f.id !== fieldId) }
//         : g
//     )
//   );

//   };

//   // currentGroupField للمساعدة عند عرض select نوع الحقل
//   const currentGroupField = groupFields.find(f => f.id === activeField?.id) || groupFields[0];

//   return (
//     <div className={styles.container}>
//       {/* العمود الشمال */}
//       <div className={styles.left}>
//         <div className={styles.groupsPanel}>
//           <div className={styles.actions}>
//             <button onClick={addGroup} className={styles.addButton}>+ New Group</button>
//             <button onClick={addField} className={styles.addButton}>+ New Field</button>
//           </div>

//           <div className={styles.groupsList}>
//             {groups.map((group) => (
//               <div
//                 key={group.id}
//                 className={styles.groupBox}
//                 onDragOver={(e) => e.preventDefault()}
//                 onDrop={(e) => handleDrop(e, group.id)}
//               >
//                 <div className={styles.groupHeader}>
//                   <input
//                     type="text"
//                     value={group.name}
//                     onChange={(e) => {handleGroupNameChange(group.id, e.target.value); autoResize(e);} }
//                     className={styles.groupNameInput}
//                     onClick={() => setActiveGroup(group)}
//                   />
//                   <button className={styles.deleteBtn} onClick={() => deleteGroup(group.id)}><i className="bi bi-trash-fill fs-3"></i></button>
//                 </div>

//                 <ul className={styles.fieldsUl}>
//                   {group.fields.map((field) => (
//                     <li
//                       key={field.id}
//                       className={styles.fieldItem}
//                       draggable
//                       onDragStart={(e) => handleDragStart(e, field.id, group.id)}
//                        onClick={() => {
//     setOpenDropdownField(null);
//   setActiveField(field);
//   }}
//                     >
//                       <span className={styles.dragHandle} aria-hidden>≡</span>
//                        <div className={styles.fieldWithDropdown}>
//                       <input
//                         type="text"
//                         value={field.label}
//                         onChange={(e) => {handleFieldLabelChange(group.id, field.id, e.target.value);  
//                           autoResize(e);
//                          setOpenDropdownField(field.id);
//                         } }
//                         className={styles.fieldInput}
//                         draggable={false}
//                       />
//                             {/* suggestions */}
//       {openDropdownField === field.id && field.label && (
//         <ul className={styles.suggestions}>
//           {inputFilterList
//             .filter((item) =>
//               item.value.toLowerCase().includes(field.label.toLowerCase())
//             )
//             .map((item) => (
//               <li
//                 key={item.key}
//                 onClick={() =>{handleFieldLabelChange(group.id, field.id, item.value); 
//                   setOpenDropdownField(null);} }
//                 className={styles.suggestionItem}
//               >
//                 {item.value}
//               </li>
//             ))}
//         </ul>
//       )}
//     </div>
//                       <button
//                         className={styles.deleteBtn}
//                         onClick={(e) => {
//                           e.stopPropagation();
//                           deleteField(group.id, field.id);
//                         }}
//                       >❌</button>
//                     </li>
//                   ))}
//                 </ul>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>

//       {/* العمود اليمين */}
//      {activeField ? (  <div className={styles.right}>
//         <> <div className={styles.navbar}>
//           <button className={activeTab === "main" ? styles.activeBtn : ""} onClick={() => setActiveTab("main")}>
//             الصفحة الرئيسية
//             </button>
//           <button className={activeTab === "fieldOptions" ? styles.activeBtn : ""} onClick={() => setActiveTab("fieldOptions")}>
//             خيارات الحقل
//             </button>
//           <button className={activeTab === "conditions" ? styles.activeBtn : ""} onClick={() => setActiveTab("conditions")}>شروط الإظهار</button>
//              <button
//       className={activeTab === "disableConditions" ? styles.activeBtn : ""}
//       onClick={() => setActiveTab("disableConditions")}
//     >
//       شروط التعطيل
//     </button>
//         </div>

//         <div className={styles.tabContent}>
//           {activeTab === "main" && (
//             <div>
//               <p>العنوان</p>
//               <input
//                 type="text"
//                 className={styles.input}
//                 value={activeField ? activeField.label : ""}
//               />
//               <p className='mt-2'>النوع</p>
//             <select className={styles.input} value={currentGroupField?.fieldTypeId ?? ""} onChange={HandleFieldTypeSelect}>
//   <option value="">اختر نوع الحقل</option>
//   {fieldSelectList?.map((e) => (
//     <option value={e.value} key={e.value}>
//       {e.text}
//     </option>
//   ))}
// </select>

//                   <div className={`mt-3 ${styles.checkboxGroup}`}>
//       <label>
//         <input type="checkbox" />
//         هل الحقل إجباري عند ظهور المسار؟
//       </label>
//       <br />
//       <label>
//         <input type="checkbox" />
//         هل الحقل للقراءة فقط؟
//       </label>
//       <br />
//            <label>
//         <input type="checkbox" />
//         هل الحقل قابل للتصدير فالتقارير؟
//       </label>
//     </div>

//             </div>
//           )}
//           {activeTab === "fieldOptions" && <div >{chooseSelectField?
//           <div className='container'>
//             <h4>فقط اختر نوع من انواع النظام</h4>
// <div className='row'>
// <div className='col-6'> <label>
//         <input   type="radio"
//       name="lookupOption"  
//       checked={useSystemLookup}
//       onChange={() => {
//         setUseSystemLookup(true);
//         setSelectedSystemLookupKey('');
//         setSystemLookupItems([]);
//       }} />
//      خيارات من كيان النظام 
//       </label></div>
// <div className='col-6'> 
//   <label>
//         <input   type="radio"
//       name="lookupOption"   
//       checked={!useSystemLookup}
//       onChange={() => {
//         setUseSystemLookup(false);
//         setSelectedSystemLookupKey('');
//         setSystemLookupItems([]);
//       }} />
//     خيارات مخصصه
//            </label>
// </div>
// <br />

// {/* لو تم تفعيل استخدام كيانات النظام نعرض select مملوء من LookUpsFrontdata.ApplicationLookUp */}
// {useSystemLookup && (
//   <div className='col-12 mt-2'>
//     <label>اختر كيان من بيان النظام</label>
//     <select className='form-control mt-2' value={selectedSystemLookupKey} onChange={(e)=>setSelectedSystemLookupKey(e.target.value)}>
//       <option value="">-- اختر --</option>
//       {LookUpsFrontdata.ApplicationLookUp.map(item => (
//         <option key={item.key} value={item.key}>{item.value}</option>
//       ))}
//     </select>

//     {/* بعد الاختيار نعرض بيانات ال-lookup الراجعة */}
//     <div className='mt-2'>
//       {systemLookupLoading ? (
//         <div>جاري التحميل ...</div>
//       ) : (
//         <div className={styles.listScroll}>
//           {systemLookupItems.length === 0 ? (
//             <div className='text-muted'>لا توجد بيانات</div>
//           ) : (
//             systemLookupItems.map((it, idx) => (
//               <div key={idx} className='list-group-item'>
//                 <strong>{it.text}</strong>
//                   <button
//               className='btn btn-sm  ms-3'
//               onClick={() => {
//                 setSystemLookupItems(prev => prev.filter((_, i) => i !== idx));
//               }}
//             >
//               🗑
//             </button>
//               </div>
//             ))
//           )}
//         </div>
//       )}
//     </div>
//   </div>
// )}
//  {customOptions.length === 0 ? (
// <></>
//       ) : (<div className={`col-12 container ${styles.listScroll} mt-3`}>{
//         customOptions.map((it, idx) => (
//           <div key={idx} className={`list-item-group `}>
//             <strong>{it.text}</strong>
//             <button
//               className="btn btn-sm  ms-3"
//               onClick={() =>
//                 setCustomOptions((prev) => prev.filter((_, i) => i !== idx))
//               }
//             >
//               🗑
//             </button>
//           </div>
//         ))}
//          </div>
//       )}
// <input type="text" placeholder=' اضافة خيار جديد' className={styles.input}   value={newOption}
//   onChange={(e) => setNewOption(e.target.value)} />
// <button className='btn btn-primary mt-2'  onClick={() => {
//         if (newOption.trim()) {
//           setCustomOptions((prev) => [...prev, { text: newOption, value: newOption }]);
//           setNewOption("");
//         }
//       }}>اضافه</button>
// </div>
//           </div>
          
          
          
//           :"لا يوجد اختيارات لهذا الحقل"}</div>}
// {activeTab === "conditions" && (
//   <div>
//     <button className="btn btn-primary mb-2" onClick={addCondition}>
//       + اضف شرط
//     </button>

//     {conditionsList.map((cond, idx) => (
//       <div key={cond.id} className="card p-2 mb-2">
//         {/* اختيار الفيلد */}
//         <select
//           className="form-control mb-2"
//           value={cond.fieldId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, fieldId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر الفيلد</option>
//           {groups.flatMap(g => g.fields).map(f => (
//             <option key={f.id} value={f.id}>{f.label}</option>
//           ))}
//         </select>

//         {/* اختيار نوع الشرط */}
//         <select
//           className="form-control mb-2"
//           value={cond.conditionTypeId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, conditionTypeId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر نوع الشرط</option>
//           {conditionTypes.map(ct => (
//             <option key={ct.value} value={ct.value}>{ct.text}</option>
//           ))}
//         </select>

//         {/* لو الشرط من النوع اللي محتاج قيمة */}
//         {/* {!(cond.conditionTypeId === "فارغ" || cond.conditionTypeId === "غير فارغ"||cond.conditionTypeId ==="Not Null"||
//           cond.conditionTypeId ==="Null" )&& (
//           <input
//             type="text"
//             className="form-control"
//             placeholder="ادخل القيمة"
//             value={cond.value}
//             onChange={(e) => {
//               const val = e.target.value;
//               setConditionsList(prev =>
//                 prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//               );
//             }}
//           />
//         )} */}
//         {(() => {
//   const selectedConditionType = conditionTypes.find(ct => ct.value === cond.conditionTypeId);
//   const conditionText = selectedConditionType?.text;

//   return !(conditionText === "فارغ" || conditionText === "غير فارغ" || conditionText === "Not Null" || conditionText === "Null") && (
//     <input
//       type="text"
//       className="form-control"
//       placeholder="ادخل القيمة"
//       value={cond.value}
//       onChange={(e) => {
//         const val = e.target.value;
//         setConditionsList(prev =>
//           prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//         );
//       }}
//     />
//   );
// })()}
//       </div>
//     ))}
//   </div>
// )}

//             {activeTab === "disableConditions" && (
//   <div>
//     <button className="btn btn-primary mb-2" onClick={addDisableCondition}>
//       + اضف شرط تعطيل
//     </button>

//     {disableConditionsList.map((cond, idx) => (
//       <div key={cond.id} className="card p-2 mb-2">
//         <select
//           className="form-control mb-2"
//           value={cond.fieldId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setDisableConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, fieldId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر الفيلد</option>
//           {groups.flatMap(g => g.fields).map(f => (
//             <option key={f.id} value={f.id}>{f.label}</option>
//           ))}
//         </select>

//         <select
//           className="form-control mb-2"
//           value={cond.conditionTypeId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setDisableConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, conditionTypeId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر نوع الشرط</option>
//           {conditionTypes.map(ct => (
//             <option key={ct.value} value={ct.value}>{ct.text}</option>
//           ))}
//         </select>

//         {/* {!(cond.conditionTypeId === "فارغ" || cond.conditionTypeId === "غير فارغ"||cond.conditionTypeId ==="Not Null"||
//           cond.conditionTypeId ==="Null" ) && (
//           <input
//             type="text"
//             className="form-control"
//             placeholder="ادخل القيمة"
//             value={cond.value}
//             onChange={(e) => {
//               const val = e.target.value;
//               setDisableConditionsList(prev =>
//                 prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//               );
//             }}
//           />
//         )} */}
//         {(() => {
//   const selectedConditionType = conditionTypes.find(ct => ct.value === cond.conditionTypeId);
//   const conditionText = selectedConditionType?.text;

//   return !(conditionText === "فارغ" || conditionText === "غير فارغ" || conditionText === "Not Null" || conditionText === "Null") && (
//     <input
//       type="text"
//       className="form-control"
//       placeholder="ادخل القيمة"
//       value={cond.value}
//       onChange={(e) => {
//         const val = e.target.value;
//         setDisableConditionsList(prev =>
//           prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//         );
//       }}
//     />
//   );
// })()}

//       </div>
//     ))}
//   </div>
// )}

//         </div></>

//       </div>):null} 
//     </div>
//   );
// }

// export default PathEditInfo;




///********************** */










































// import { v4 as uuidv4 } from "uuid";
// import { Api_URL } from '../../Resources/ApiUrl';
// import LookUpsFrontdata from '../../Resources/LookUps'
// import  { useState ,useEffect } from "react";
// import styles from "./PathEditInfo.module.css";

// function PathEditInfo() {
//   const [openDropdownField, setOpenDropdownField] = useState(null);
//   const [activeField, setActiveField] = useState(null);
//   const [ActiveGroup, setActiveGroup] = useState(null);
//   const [activeTab, setActiveTab] = useState("main");
//   const inputFilterList = LookUpsFrontdata.FieldHelper;
//   const [fieldSelectList, setfieldSelectList] = useState(null);
//   const [chooseSelectField, setchooseSelectField] = useState(false);
// const [useCustomLookup, setUseCustomLookup] = useState(false);
// const [customOptions, setCustomOptions] = useState([]);
// const [newOption, setNewOption] = useState("");

//   // --- جديد: حالات لاستخدام خيارات من كيان النظام وجلب بياناته ---
//   const [useSystemLookup, setUseSystemLookup] = useState(false); // تم تفعيل خيار استخدام كيانات النظام
//   const [selectedSystemLookupKey, setSelectedSystemLookupKey] = useState(""); // ال-key المختار من ApplicationLookUp
//   const [systemLookupItems, setSystemLookupItems] = useState([]); // النتيجة الراجعة من ال-API
//   const [systemLookupLoading, setSystemLookupLoading] = useState(false);
// const [conditionsList, setConditionsList] = useState([]); // كل الشروط المضافة
// const [conditionTypes, setConditionTypes] = useState([]); // أنواع الشروط من API

//   // وظيفة مساعدة بسيطة لتفادي أخطاء auto-resize إذا كانت مفقودة

//   const [disableConditionsList, setDisableConditionsList] = useState([]);

//   const isSelectField = activeField?.type === "One Select" 
//   || activeField?.type === "MultibelSelect" 
//   || activeField?.type === "خيارات متعددة (Select)" 
//   || activeField?.type === "اختيار واحد (Select)"
//   || activeField?.type === "اختيار واحد (Select)"
//   || activeField?.type === "خيارات متعددة (CheckBox)"
//   || activeField?.type === "CheckBox Group"
//   || activeField?.type === "Radio Button"
//   || activeField?.type === "View List"
//   || activeField?.type === "قائمة نصية"
//   ;
//   // هذا ال-state يحتوى إعدادات الحقل (نستخدم عنصر واحد لكل فيلد عند الطلب)
// const [pathGroups, setPathGroups] = useState([
//     {
//       id:  uuidv4(),
//       name: "Group",
//       viewOrder: 0,
//       title:"Group",
//       type: null,
//       groupFields: [
//         {
//           id: uuidv4(),
//           fieldTypeId: null,
//           name: "field 1",
//           viewOrder: 0,
//           isReadOnly: false,
//           isRequired: false,
//           isReportExportable: false,
//           isForVisitReport: false,
//           isForSpecialSammaryReport: false,
//           title: "field 1",
//           type: null,
//           unified: 0,
//           isOptionRelatedToEntity: false,
//           optionsRelatedToEntityId: null,
//           fieldOption: [
//             {
//               id: null,
//               name: null,
//               isActive: 0,
//               relatedCategoryPathFieldId: null,
//               relatedEntityOptionId: null,
//               relatedEntityId: null,
//               viewOrder: 0,
//               showIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: false,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: null,
//                       andorOr: false,
//                       viewOrder: 0,
//                       valueList: [null],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               selectedIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: false,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: null,
//                       andorOr: false,
//                       viewOrder: 0,
//                       valueList: [null],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               disabledIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: false,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: null,
//                       andorOr: false,
//                       viewOrder: 0,
//                       valueList: [null],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ]
//             }
//           ],
//           showIfCondetionGroup: [
//             {
//               id: null,
//               relatedToCategoryPathFieldId: null,
//               categoryPathFieldEventGroupId: null,
//               conditionForId: null,
//               andorOr: false,
//               viewOrder: 0,
//               conditions: [
//                 {
//                   id: null,
//                   fieldConditionGroupId: null,
//                   fieldId: null,
//                   conditionForId: null,
//                   conditionTypeId: null,
//                   value: null,
//                   andorOr: false,
//                   viewOrder: 0,
//                   valueList: [null],
//                   conditionRelationTypeId: null,
//                   categoryPathFieldRelatedEntityFieldId: null
//                 }
//               ]
//             }
//           ],
//           readOnlyIfCondetionGroup: [
//             {
//               id: null,
//               relatedToCategoryPathFieldId: null,
//               categoryPathFieldEventGroupId: null,
//               conditionForId: null,
//               andorOr: false,
//               viewOrder: 0,
//               conditions: [
//                 {
//                   id: null,
//                   fieldConditionGroupId: null,
//                   fieldId: null,
//                   conditionForId: null,
//                   conditionTypeId: null,
//                   value: null,
//                   andorOr: false,
//                   viewOrder: 0,
//                   valueList: [null],
//                   conditionRelationTypeId: null,
//                   categoryPathFieldRelatedEntityFieldId: null
//                 }
//               ]
//             }
//           ],
//           disabledIfCondetionGroup: [
//             {
//               id: null,
//               relatedToCategoryPathFieldId: null,
//               categoryPathFieldEventGroupId: null,
//               conditionForId: null,
//               andorOr: false,
//               viewOrder: 0,
//               conditions: [
//                 {
//                   id: null,
//                   fieldConditionGroupId: null,
//                   fieldId: null,
//                   conditionForId: null,
//                   conditionTypeId: null,
//                   value: null,
//                   andorOr: false,
//                   viewOrder: 0,
//                   valueList: [null],
//                   conditionRelationTypeId: null,
//                   categoryPathFieldRelatedEntityFieldId: null
//                 }
//               ]
//             }
//           ],
//           eventsGroup: [
//             {
//               id: null,
//               events: [
//                 {
//                   id: null,
//                   actionTypeId: null,
//                   dynamicFunctionId: null,
//                   dynamicFunctionIdentifire: null,
//                   parameters: [
//                     {
//                       id: null,
//                       name: null,
//                       parameterIdentifire: null,
//                       parameterId: null,
//                       categoryPathFieldId: null,
//                       staticValue: null,
//                       isRelatedToPathFields: false,
//                       fieldShouldRelatedToEntityTypeId: null
//                     }
//                   ],
//                   results: [
//                     {
//                       id: null,
//                       name: null,
//                       outputIdentifire: null,
//                       resultId: null,
//                       categoryPathFieldId: null,
//                       isNotification: false,
//                       isPathResult: false,
//                       isPathValue: false
//                     }
//                   ],
//                   processOrder: 0
//                 }
//               ],
//               executeTrigger: {
//                 additionalProp1: false,
//                 additionalProp2: false,
//                 additionalProp3: false
//               },
//               executeIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedToCategoryPathFieldId: null,
//                   categoryPathFieldEventGroupId: null,
//                   conditionForId: null,
//                   andorOr: false,
//                   viewOrder: 0,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldConditionGroupId: null,
//                       fieldId: null,
//                       conditionForId: null,
//                       conditionTypeId: null,
//                       value: null,
//                       andorOr: false,
//                       viewOrder: 0,
//                       valueList: [null],
//                       conditionRelationTypeId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               andorOr: false,
//               processOrder: 0
//             }
//           ]
//         }
//       ]
//     }
//   ])


//   const autoResize = (e) => {
//     if (!e || !e.target) return;
//     try {
//       e.target.style.height = "auto";
//       e.target.style.height = `${e.target.scrollHeight}px`;
//     } catch (err) { /* noop */ }
//   };

//    useEffect(() => {
//     const fetchFieldTypes = async () => {
//       try {
//         const entity = LookUpsFrontdata.ApplicationLookUp.find(
//           (e) => e.value === "أنواع الحقول"
//         );

//         if (!entity) return;

//         const dto = {
//           entityId: entity.key,
//           condetion: null,
//         };

//         const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
//           method: "POST",
//           headers: { "Content-Type": "application/json" },
//           body: JSON.stringify(dto),
//         });

//         const data = await res.json();

//         if (data?.succeeded && data?.data?.items) {
//           const mapped = data.data.items.map((c) => ({
//             value: c.value,
//             text: c.text,
//           }));
//           setfieldSelectList(mapped);
//         }
//       } catch (err) {
//         console.error(err);
//         if (typeof toast !== 'undefined') {
//           toast.error("خطأ فالتحميل", {
//             position: "top-right",
//             style: { backgroundColor: "red", color: "white" },
//           });
//         }
//       }
//     };

//     fetchFieldTypes();
//   }, []);

//   // --- جديد: عندما يختار المستخدم كيان من ApplicationLookUp نجيب منه بيانات الـ Lookup ---
//   useEffect(() => {
//     if (!selectedSystemLookupKey) {
//       setSystemLookupItems([]);
//       return;
//     }

//     const fetchSystemLookupItems = async () => {
//       setSystemLookupLoading(true);
//       try {
//         const dto = { entityId: selectedSystemLookupKey, condetion: null };
//         const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
//           method: 'POST',
//           headers: { 'Content-Type': 'application/json' },
//           body: JSON.stringify(dto),
//         });
//         const data = await res.json();
//         if (data?.succeeded && data?.data?.items) {
//           // نحفظ الـ items عشان نعرضهم في ال-list (نأخذ text و value من كل item)
//           setSystemLookupItems(data.data.items.map(it => ({ text: it.text ?? it.value, value: it.value })));
//         } else {
//           setSystemLookupItems([]);
//         }
//       } catch (err) {
//         console.error(err);
//         setSystemLookupItems([]);
//         if (typeof toast !== 'undefined') {
//           toast.error("خطأ في جلب بيانات الـ Lookup");
//         }
//       } finally {
//         setSystemLookupLoading(false);
//       }
//     };

//     fetchSystemLookupItems();
//   }, [selectedSystemLookupKey]);


//   useEffect(() => {
//     if (!activeField) return;

//     const updatedGroup = pathGroups.find((g) =>
//       g.groupFields.some((f) => f.id === activeField.id)
//     );
//     if (!updatedGroup) return;

//     const updatedField = updatedGroup.groupFields.find(
//       (f) => f.id === activeField.id
//     );

//     if (updatedField && updatedField.name !== activeField.name) {
//       setActiveField(updatedField);
//     }
//   }, [pathGroups]);



//   useEffect(() => {
//   const fetchConditionTypes = async () => {
//     try {
//       const entity = LookUpsFrontdata.ApplicationLookUp.find(
//         (e) => e.value === "أنواع الشروط"
//       );
//       if (!entity) return;

//       const dto = { entityId: entity.key, condetion: null };
//       const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
//         method: "POST",
//         headers: { "Content-Type": "application/json" },
//         body: JSON.stringify(dto),
//       });
//       const data = await res.json();

//       if (data?.succeeded && data?.data?.items) {
//         setConditionTypes(data.data.items.map(c => ({ value: c.value, text: c.text })));
//       }
//     } catch (err) {
//       console.error(err);
//     }
//   };

//   fetchConditionTypes();
// }, []);


// useEffect(() => {
//   if (activeField && selectedSystemLookupKey && systemLookupItems.length > 0) {
//     handleSelectSystemLookup(activeField.id, selectedSystemLookupKey, systemLookupItems);
//   }
//   else if(activeField && !selectedSystemLookupKey){
//         setPathGroups(prev =>
//         prev.map(group => ({
//           ...group,
//           groupFields: group.groupFields.map(field =>
//             field.id === activeField.id
//               ? {
//                   ...field,
//                   isOptionRelatedToEntity: false,
//                   isActive:0,
//                   optionsRelatedToEntityId: null,
//                   fieldOption: [], 
//                 }
//               : field
//           ),
//         }))
//       );
//   }
// }, [systemLookupItems, activeField, selectedSystemLookupKey]);

// let generateEmptyField = (count) => 
//   {
//     return {
//           id:  uuidv4(),
//           fieldTypeId: null,
//           name: "field 1",
//           viewOrder: count  || 0,
//           isReadOnly: false,
//           isRequired: false,
//           isReportExportable: false,
//           isForVisitReport: false,
//           isForSpecialSammaryReport: false,
//           title: null,
//           type: null,
//           unified: 0,
//           isOptionRelatedToEntity: false,
//           optionsRelatedToEntityId: null,
//           fieldOption: [
//             {
//               id: null,
//               name: null,
//               isActive: 0,
//               relatedCategoryPathFieldId: null,
//               relatedEntityOptionId: null,
//               relatedEntityId: null,
//               viewOrder: 0,
//               showIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: false,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: null,
//                       andorOr: false,
//                       viewOrder: 0,
//                       valueList: [null],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               selectedIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: false,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: null,
//                       andorOr: false,
//                       viewOrder: 0,
//                       valueList: [null],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               disabledIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedCategoryPathFieldOptionId: null,
//                   conditionForId: null,
//                   andorOr: false,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldId: null,
//                       conditionTypeId: null,
//                       value: null,
//                       andorOr: false,
//                       viewOrder: 0,
//                       valueList: [null],
//                       relatedCategoryPathFieldId: null,
//                       relatedEntityId: null,
//                       relatedEntityOptionId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ]
//             }
//           ],
//           showIfCondetionGroup: [
//             {
//               id: null,
//               relatedToCategoryPathFieldId: null,
//               categoryPathFieldEventGroupId: null,
//               conditionForId: null,
//               andorOr: false,
//               viewOrder: 0,
//               conditions: [
//                 {
//                   id: null,
//                   fieldConditionGroupId: null,
//                   fieldId: null,
//                   conditionForId: null,
//                   conditionTypeId: null,
//                   value: null,
//                   andorOr: false,
//                   viewOrder: 0,
//                   valueList: [null],
//                   conditionRelationTypeId: null,
//                   categoryPathFieldRelatedEntityFieldId: null
//                 }
//               ]
//             }
//           ],
//           readOnlyIfCondetionGroup: [
//             {
//               id: null,
//               relatedToCategoryPathFieldId: null,
//               categoryPathFieldEventGroupId: null,
//               conditionForId: null,
//               andorOr: false,
//               viewOrder: 0,
//               conditions: [
//                 {
//                   id: null,
//                   fieldConditionGroupId: null,
//                   fieldId: null,
//                   conditionForId: null,
//                   conditionTypeId: null,
//                   value: null,
//                   andorOr: false,
//                   viewOrder: 0,
//                   valueList: [null],
//                   conditionRelationTypeId: null,
//                   categoryPathFieldRelatedEntityFieldId: null
//                 }
//               ]
//             }
//           ],
//           disabledIfCondetionGroup: [
//             {
//               id: null,
//               relatedToCategoryPathFieldId: null,
//               categoryPathFieldEventGroupId: null,
//               conditionForId: null,
//               andorOr: false,
//               viewOrder: 0,
//               conditions: [
//                 {
//                   id: null,
//                   fieldConditionGroupId: null,
//                   fieldId: null,
//                   conditionForId: null,
//                   conditionTypeId: null,
//                   value: null,
//                   andorOr: false,
//                   viewOrder: 0,
//                   valueList: [null],
//                   conditionRelationTypeId: null,
//                   categoryPathFieldRelatedEntityFieldId: null
//                 }
//               ]
//             }
//           ],
//           eventsGroup: [
//             {
//               id: null,
//               events: [
//                 {
//                   id: null,
//                   actionTypeId: null,
//                   dynamicFunctionId: null,
//                   dynamicFunctionIdentifire: null,
//                   parameters: [
//                     {
//                       id: null,
//                       name: null,
//                       parameterIdentifire: null,
//                       parameterId: null,
//                       categoryPathFieldId: null,
//                       staticValue: null,
//                       isRelatedToPathFields: false,
//                       fieldShouldRelatedToEntityTypeId: null
//                     }
//                   ],
//                   results: [
//                     {
//                       id: null,
//                       name: null,
//                       outputIdentifire: null,
//                       resultId: null,
//                       categoryPathFieldId: null,
//                       isNotification: false,
//                       isPathResult: false,
//                       isPathValue: false
//                     }
//                   ],
//                   processOrder: 0
//                 }
//               ],
//               executeTrigger: {
//                 additionalProp1: false,
//                 additionalProp2: false,
//                 additionalProp3: false
//               },
//               executeIfCondetionGroup: [
//                 {
//                   id: null,
//                   relatedToCategoryPathFieldId: null,
//                   categoryPathFieldEventGroupId: null,
//                   conditionForId: null,
//                   andorOr: false,
//                   viewOrder: 0,
//                   conditions: [
//                     {
//                       id: null,
//                       fieldConditionGroupId: null,
//                       fieldId: null,
//                       conditionForId: null,
//                       conditionTypeId: null,
//                       value: null,
//                       andorOr: false,
//                       viewOrder: 0,
//                       valueList: [null],
//                       conditionRelationTypeId: null,
//                       categoryPathFieldRelatedEntityFieldId: null
//                     }
//                   ]
//                 }
//               ],
//               andorOr: false,
//               processOrder: 0
//             }
//           ]
//         }
      
//   }




//   let HandleFieldTypeSelect = (e) => {
//     const selectedValue = e.target.value;   // value من الـ option
//     const selectedText = e.target.options[e.target.selectedIndex].text; // النص الظاهر

//     if (selectedText === "One Select" || selectedText === "MultibelSelect" || selectedText === "خيارات متعددة (Select)" || selectedText === "اختيار واحد (Select)") {
//       setchooseSelectField(true);
//     } else {
//        setchooseSelectField(false);
//     }

//     // نحدث ال-pathGroups بنفس التغيير
//     setPathGroups((prev) =>
//       prev.map((group) => ({
//         ...group,
//         groupFields: group.groupFields.map((field) =>
//           field.id === activeField?.id
//             ? { ...field, fieldTypeId: selectedValue, type: selectedText }
//             : field
//         ),
//       }))
//     );

// setActiveField((prev) => ({
//   ...prev,
//   fieldTypeId: selectedValue,
//   type: selectedText,
// }));

//   }

// const handleSelectSystemLookup = (fieldId, lookupKey, lookupItems, customOptions = []) => {
//   setPathGroups(prev =>
//     prev.map(group => ({
//       ...group,
//       groupFields: group.groupFields.map(field =>
//         field.id === fieldId
//           ? {
//               ...field,
//               isOptionRelatedToEntity: true,
//               optionsRelatedToEntityId: lookupKey,
//               fieldOption: [
//                 // system lookup items
//                 ...lookupItems.map((item, index) => ({
//                   id: uuidv4(),
//                   name: item.text,
//                   isActive: 1,
//                   relatedCategoryPathFieldId: null,
//                   relatedEntityOptionId: item.value, // لاحظ هنا value من API
//                   relatedEntityId: null,
//                   viewOrder: index,
//                   showIfCondetionGroup: [],
//                   selectedIfCondetionGroup: [],
//                   disabledIfCondetionGroup: [],
//                 })),
//                 // custom options (merge)
//                 ...customOptions.map((c, i) => ({
//                   id: uuidv4(),
//                   name: c.text,
//                   isActive: 1,
//                   relatedCategoryPathFieldId: null,
//                   relatedEntityOptionId: null,
//                   relatedEntityId: null,
//                   viewOrder: lookupItems.length + i,
//                   showIfCondetionGroup: [],
//                   selectedIfCondetionGroup: [],
//                   disabledIfCondetionGroup: [],
//                 })),
//               ],
//             }
//           : field
//       ),
//     }))
//   );
// };



// const handleAddCustomOption = (fieldId, newOption, useSystemLookup, systemItems) => {
//   setPathGroups(prev =>
//     prev.map(group => ({
//       ...group,
//       groupFields: group.groupFields.map(field =>
//         field.id === fieldId
//           ? {
//               ...field,
//               fieldOption: [
//                 ...(useSystemLookup
//                   ? field.fieldOption.filter(o => o.relatedEntityOptionId)
//                   : []),
//                 {
//                   id: uuidv4(),
//                   name: newOption,
//                   isActive: 1,
//                   relatedCategoryPathFieldId: null,
//                   relatedEntityOptionId: null,
//                   relatedEntityId: null,
//                   viewOrder: field.fieldOption.length,
//                   showIfCondetionGroup: null,
//                   selectedIfCondetionGroup: null,
//                   disabledIfCondetionGroup: null,
//                 },
//               ],
//             }
//           : field
//       ),
//     }))
//   );
// };


//   const addCondition = () => {
//   setConditionsList(prev => [
//     ...prev,
//     { id: Date.now(), fieldId: "", conditionTypeId: "", value: "" }
//   ]);
// };

// const addDisableCondition = () => {
//   setDisableConditionsList(prev => [
//     ...prev,
//     { id: Date.now(), fieldId: "", conditionTypeId: "", value: "" }
//   ]);
// };

//   // إضافة جروب
//   const addGroup = () => {

//     // نضيف جروب فارغ في pathGroups
//      setPathGroups((prev) => [
//     ...prev,
//     {
//       id: uuidv4(),
//       name: `Group`,
//       viewOrder: prev.length,
//       title: `Group`,
//       type: null,
//             groupFields: [
//      generateEmptyField(0)
//       ]
//     }
//   ]);


//   };

 
//   // تعديل اسم الجروب
//   const handleGroupNameChange = (groupId, newName) => {
//     console.log("Changing group name:", groupId, newName);
//          setPathGroups(prev =>
//   prev.map((g) =>
//     g.id === groupId ? { ...g, name: newName } : g
//   )
// );

//   };

//   // إضافة فيلد
//   const addField = () => {
//   setPathGroups((prev) => {
//     if (prev.length === 0) {
//       // أول Group فاضي → نضيفه ونحط فيه Field
//       const newGroup = {
//         id: uuidv4(),
//         name: "Group 1",
//         viewOrder: 0,
//         title: "Group 1",
//         type: null,
//         groupFields: [generateEmptyField(0)]
//       };
//       return [newGroup];
//     }
//     // عندنا Group موجود → نزود Field جديد في أول Group
//     return prev.map((g, idx) => {
//       if (idx !== 0) return g;

//       // حساب الترتيب الجديد بناءً على عدد الفيلدات الحالية في الجروب ده
//       const newFields = [...g.groupFields, generateEmptyField(g.groupFields.length)];

//       // نضمن ترتيب viewOrder متسلسل من 0..n-1
//       const reOrdered = newFields.map((f, i) => ({ ...f, viewOrder: i }));

//       return { ...g, groupFields: reOrdered };
//     });

//   });
// };

// const handleFieldLabelChange = (groupId, fieldId, newLabel,newKey) => {
//   setPathGroups((prev) =>
//     prev.map((g) =>
//       g.id === groupId
//         ? {
//             ...g,
//             groupFields: g.groupFields.map((f) =>
//               f.id === fieldId ? { ...f, name: newLabel,id:newKey?newKey:f.id } : f
//             ),
//           }
//         : g
//     )
//   );

//   // تحديث الـ ActiveField
//   setActiveField((af) => {
//     // لو الـ activeField الحالي مش هو نفس الفيلد، ممكن نسيبه زي ما هو
//     if (af && af.id !== fieldId) return af;

//     // لو مفيش activeField أو هو نفس الفيلد، هنعيده كامل
//     let updatedField = null;
//     setPathGroups((latest) => {
//       const grp = latest.find((g) => g.id === groupId);
//       if (grp) {
//         updatedField = grp.groupFields.find((f) => f.id === (newKey?newKey:fieldId));
//       }
//       return latest;
//     });

//     return updatedField || af;
//   });

// };

// const handleCheckboxChange = (propName) => (e) => {

//   const value = e.target.checked;

//   setActiveField((prev) => ({
//     ...prev,
//     [propName]: e.target.checked
//   }));

// setPathGroups((prev) =>
//     prev.map((group) => ({
//       ...group,
//       groupFields: group.groupFields.map((field) =>
//         field.id === activeField?.id
//           ? { ...field, [propName]: value }
//           : field
//       ),
//     }))
//   );
// };

//   // // Drag Start
//   const handleDragStart = (e, fieldId, fromGroupId) => {
//     const payload = JSON.stringify({ fieldId, fromGroupId });
//     e.dataTransfer.setData("text/plain", payload);
//     e.dataTransfer.effectAllowed = "move";
//   };


// const handleDrop = (e, targetGroupId) => {
//   e.preventDefault();
//   const raw = e.dataTransfer.getData("text/plain");
//   if (!raw) return;

//   let obj;
//   try {
//     obj = JSON.parse(raw);
//   } catch {
//     return;
//   }

//   const { fieldId, fromGroupId } = obj;
//   if (fromGroupId === targetGroupId) return;

//   setPathGroups((prev) => {
//     let fieldObj = null;

//     // شيل الفيلد من الجروب الأصلي
//     const removed = prev.map((g) => {
//       if (g.id === fromGroupId) {
//         const filtered = g.groupFields.filter((f) => {
//           if (f.id === fieldId) {
//             fieldObj = f;
//             return false;
//           }
//           return true;
//         });

//         // رتب الأوردر بعد الحذف
//         const reOrdered = filtered.map((f, idx) => ({
//           ...f,
//           viewOrder: idx,
//         }));

//         return { ...g, groupFields: reOrdered };
//       }
//       return g;
//     });

//     if (!fieldObj) return prev;

//     // ضيف الفيلد في الجروب الهدف
//     return removed.map((g) => {
//       if (g.id === targetGroupId) {
//         const newFields = [...g.groupFields, { ...fieldObj }];

//         // رتب الأوردر بعد الإضافة
//         const reOrdered = newFields.map((f, idx) => ({
//           ...f,
//           viewOrder: idx,
//         }));

//         return { ...g, groupFields: reOrdered };
//       }
//       return g;
//     });
//   });
// };


//   // // حذف جروب
//   const deleteGroup = (groupId) => {
//     setPathGroups((prev) => prev.filter((g) => g.id !== groupId));
//   };

  
//   // // حذف فيلد
//   const deleteField = (groupId, fieldId) => {
// setPathGroups((prev) =>
//     prev.map((g) =>
//       g.id === groupId
//         ? {
//             ...g,
//             groupFields: g.groupFields.filter((f) => f.id !== fieldId),
//           }
//         : g
//     )
//   );
//   // لو الفيلد المتحدد activeField هو نفسه اللي اتمسح رجعه null
//   setActiveField((af) => (af && af.id === fieldId ? null : af));
//   };


// const addOption = (option, fromSystem = false) => {
//   setPathGroups((prev) =>
//     prev.map((group) => ({
//       ...group,
//       groupFields: group.groupFields.map((field) =>
//         field.id === activeField?.id
//           ? {
//               ...field,
//               fieldOption: [
//                 ...field.fieldOption,
//                 {
//                   id: fromSystem ? option.id : uuidv4(),    
//                   name: option.text || option.name || option.value,
//                   isActive: 1,
//                   relatedCategoryPathFieldId: null,
//                   relatedEntityOptionId: null,
//                   relatedEntityId: null,
//                   viewOrder:field.fieldOption.length===0?0: field.fieldOption.length-1,       // ترتيب حسب الطول الحالي
//                   showIfCondetionGroup: [],
//                   selectedIfCondetionGroup: [],
//                   disabledIfCondetionGroup: [],
//                 },
//               ],
//             }
//           : field
//       ),
//     }))
//   );
// };

//   // currentGroupField للمساعدة عند عرض select نوع الحقل
//   // const currentGroupField = groupFields.find(f => f.id === activeField?.id) || groupFields[0];

//   return (
//     <div className={styles.container}>
//       {/* العمود الشمال */}
//       <div className={styles.left}>
//         <div className={styles.groupsPanel}>
//           <div className={styles.actions}>
//             <button onClick={addGroup} className={styles.addButton}>+ New Group</button>
//             <button onClick={addField} className={styles.addButton}>+ New Field</button>
//           </div>

//           <div className={styles.groupsList}>
//             {pathGroups.map((group) => (
//               <div
//                 key={group.id}               
//                 className={styles.groupBox}
//                 onDragOver={(e) => e.preventDefault()}
//                 onDrop={(e) => handleDrop(e, group.id)}
//               >
//                 <div className={styles.groupHeader}>
//                   <input
//                     type="text"
//                     value={group.name}
//                     onChange={(e) => {handleGroupNameChange(group.id, e.target.value); autoResize(e);} }
//                     className={styles.groupNameInput}
//                   />
//                   <button className={styles.deleteBtn} onClick={() => deleteGroup(group.id)}><i className="bi bi-trash-fill fs-3"></i></button>
//                 </div>

//                 <ul className={styles.fieldsUl}>
//                   {group.groupFields.map((field) => (
//                     <li
//                       key={field.id}
//                       className={styles.fieldItem}
//                       draggable
//                       onDragStart={(e) => handleDragStart(e, field.id, group.id)}
//                        onClick={() => {
//     setOpenDropdownField(null);
//   setActiveField(field);

//   }}
//                     >
//                       <span className={styles.dragHandle} aria-hidden>≡</span>
//                        <div className={styles.fieldWithDropdown}>
//                       <input
//                         type="text"
//                         value={field.name}
//                         onChange={(e) => {handleFieldLabelChange(group.id, field.id, e.target.value);  
//                           autoResize(e);
//                          setOpenDropdownField(field.id);
//                         } }
//                         className={styles.fieldInput}
//                         draggable={false}
//                       />
//                             {/* suggestions */}
//       {openDropdownField && openDropdownField === field.id && (
//         <ul className={styles.suggestions}>
//           {inputFilterList
//             .filter((item) =>
//               item.value.toLowerCase().includes(field.name.toLowerCase())
//             )
//             .map((item) => (
//               <li
//                 key={item.key}
//                 onClick={(e) =>{
//                   e.stopPropagation();
//                   handleFieldLabelChange(group.id, field.id, item.value,item.key);
//                   setActiveField((prev) =>
//     prev?.id === field.id
//       ? { ...prev, name: item.value, id: item.key }
//       : prev
//   ); 
//                   setOpenDropdownField(null);} }
//                 className={styles.suggestionItem}
//               >
//                 {item.value}
//               </li>
//             ))}
//         </ul>
//       )}
//     </div>
//                       <button
//                         className={styles.deleteBtn}
//                         onClick={(e) => {
//                           e.stopPropagation();
//                           deleteField(group.id, field.id);
//                         }}
//                       >❌</button>
//                     </li>
//                   ))}
//                 </ul>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>

//       {/* العمود اليمين */}
//      {activeField ? (  <div className={styles.right}>
//         <> <div className={styles.navbar}>
//           <button className={activeTab === "main" ? styles.activeBtn : ""} onClick={() => setActiveTab("main")}>
//             الصفحة الرئيسية
//             </button>
//           <button className={activeTab === "fieldOptions" ? styles.activeBtn : ""} onClick={() => setActiveTab("fieldOptions")}>
//             خيارات الحقل
//             </button>
//           <button className={activeTab === "conditions" ? styles.activeBtn : ""} onClick={() => setActiveTab("conditions")}>شروط الإظهار</button>
//              <button
//       className={activeTab === "disableConditions" ? styles.activeBtn : ""}
//       onClick={() => setActiveTab("disableConditions")}
//     >
//       شروط التعطيل
//     </button>
//         </div>

//         <div className={styles.tabContent}>
//           {activeTab === "main" && (
//             <div>
//               <p>العنوان</p>
//               <input
//                 type="text"
//                 className={styles.input}
//                 value={activeField ? activeField.name : ""}
//               />
//               <p className='mt-2'>النوع</p>
//             <select className={styles.input} value={activeField?.fieldTypeId ?? ""} onChange={HandleFieldTypeSelect}>
//   <option value="">اختر نوع الحقل</option>
//   {fieldSelectList?.map((e) => (
//     <option value={e.value} key={e.value}>
//       {e.text}
//     </option>
//   ))}
// </select>

//                   <div className={`mt-3 ${styles.checkboxGroup}`}>
//       <label>
//         <input type="checkbox"     onChange={handleCheckboxChange("isRequired")}     checked={activeField?.isRequired || false} />
//         هل الحقل إجباري عند ظهور المسار؟
//       </label>
//       <br />
//       <label>
//         <input type="checkbox"     checked={activeField?.isReadOnly || false}
//     onChange={handleCheckboxChange("isReadOnly")} />
//         هل الحقل للقراءة فقط؟
//       </label>
//       <br />
//            <label>
//         <input type="checkbox"    checked={activeField?.isReportExportable || false}
//     onChange={handleCheckboxChange("isReportExportable")}  />
//         هل الحقل قابل للتصدير فالتقارير؟
//       </label>
//     </div>

//             </div>
//           )}
//           {activeTab === "fieldOptions" && <div >{ 
//         isSelectField?
//           <div className='container'>
//             <h4>فقط اختر نوع من انواع النظام</h4>
// <div className='row'>
// <div className='col-6'> <label>
//         <input   type="radio"
//       name="lookupOption"  
//       checked={useSystemLookup}
// onChange={() => {
//   setUseSystemLookup(true); 
//   setSelectedSystemLookupKey('');
//   setSystemLookupItems([]);

//   if (activeField) {
//     setPathGroups(prev =>
//       prev.map(group => ({
//         ...group,
//         groupFields: group.groupFields.map(field =>
//           field.id === activeField.id
//             ? { ...field, fieldOption: [] } // Reset
//             : field
//         ),
//       }))
//     );
//   }
// }} />
//      خيارات من كيان النظام 
//       </label></div>
// <div className='col-6'> 
//   <label>
//         <input   type="radio"
//       name="lookupOption"   
//       checked={!useSystemLookup}
//       onChange={() => {
//   setUseSystemLookup(false);
//   setSelectedSystemLookupKey('');
//   setSystemLookupItems([]);

//   if (activeField) {
//     setPathGroups(prev =>
//       prev.map(group => ({
//         ...group,
//         groupFields: group.groupFields.map(field =>
//           field.id === activeField.id
//             ? { ...field, fieldOption: [] } // Reset بردو
//             : field
//         ),
//       }))
//     );
//   }
// }} />
//     خيارات مخصصه
//            </label>
// </div>
// <br />

// {/* لو تم تفعيل استخدام كيانات النظام نعرض select مملوء من LookUpsFrontdata.ApplicationLookUp */}
// {useSystemLookup && (
//   <div className='col-12 mt-2'>
//     <label>اختر كيان من بيان النظام</label>
//     <select className='form-control mt-2' value={selectedSystemLookupKey}  onChange={(e) => {
//     const key = e.target.value;
//     setSelectedSystemLookupKey(key);
//     // if (activeField) {
//     //   handleSelectSystemLookup(activeField.id, key,systemLookupItems);
//     // }
//   }}>
//       <option value="">-- اختر --</option>
//       {LookUpsFrontdata.ApplicationLookUp.map(item => (
//         <option key={item.key} value={item.key} >{item.value}</option>
//       ))}
//     </select>

//     {/* بعد الاختيار نعرض بيانات ال-lookup الراجعة */}
//     <div className='mt-2'>
//       {systemLookupLoading ? (
//         <div>جاري التحميل ...</div>
//       ) : (
//         <div className={styles.listScroll}>
//           {systemLookupItems.length === 0 ? (
//             <div className='text-muted'>لا توجد بيانات</div>
//           ) : (
//             systemLookupItems.map((it, idx) => (
//               <div key={idx} className='list-group-item'>
//                 <strong>{it.text}</strong>
//                   <button
//               className='btn btn-sm  ms-3'
//               onClick={() => {
//                 setSystemLookupItems(prev => prev.filter((_, i) => i !== idx));
//               }}
//             >
//               🗑
//             </button>
//               </div>
//             ))
//           )}
//         </div>
//       )}
//     </div>
//   </div>
// )}
//  {   customOptions.length === 0 ? (
// <></>
//       ) : (<div className={`col-12 container ${styles.listScroll} mt-3`}>{
//         customOptions.map((it, idx) => (
//           <div key={idx} className={`list-item-group `}>
//             <strong>{it.text}</strong>
//             <button
//               className="btn btn-sm  ms-3"
//               onClick={() => {
//           // احذف option واحد بس
//           setPathGroups(prev =>
//             prev.map(group => ({
//               ...group,
//               groupFields: group.groupFields.map(field =>
//                 field.id === activeField.id
//                   ? {
//                       ...field,
//                       fieldOption: field.fieldOption.filter((_, i) => i !== idx),
//                     }
//                   : field
//               ),
//             }))
//           );
//         }}
//             >
//               🗑
//             </button>
//           </div>
//         ))}
//          </div>
//       )}
// <input type="text" placeholder=' اضافة خيار جديد' className={styles.input}   value={newOption}
//   onChange={(e) => setNewOption(e.target.value)} />
// <button className='btn btn-primary mt-2' 
//       onClick={() => {
//     if(newOption.trim() && activeField) {
//       handleAddCustomOption(activeField.id, newOption);
//       setNewOption("");}
//     }
//       }>اضافه</button>
// </div>
//           </div>
          
          
          
//           :"لا يوجد اختيارات لهذا الحقل"}</div>}


          
// {activeTab === "conditions" && (
//   <div>
//     <button className="btn btn-primary mb-2" onClick={addCondition}>
//       + اضف شرط
//     </button>

//     {conditionsList.map((cond, idx) => (
//       <div key={cond.id} className="card p-2 mb-2">
//         {/* اختيار الفيلد */}
//         <select
//           className="form-control mb-2"
//           value={cond.fieldId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, fieldId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر الفيلد</option>
//           {pathGroups.flatMap(g => g.fields).map(f => (
//             <option key={f.id} value={f.id}>{f.label}</option>
//           ))}
//         </select>

//         {/* اختيار نوع الشرط */}
//         <select
//           className="form-control mb-2"
//           value={cond.conditionTypeId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, conditionTypeId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر نوع الشرط</option>
//           {conditionTypes.map(ct => (
//             <option key={ct.value} value={ct.value}>{ct.text}</option>
//           ))}
//         </select>

//         {(() => {
//   const selectedConditionType = conditionTypes.find(ct => ct.value === cond.conditionTypeId);
//   const conditionText = selectedConditionType?.text;

//   return !(conditionText === "فارغ" || conditionText === "غير فارغ" || conditionText === "Not Null" || conditionText === "Null") && (
//     <input
//       type="text"
//       className="form-control"
//       placeholder="ادخل القيمة"
//       value={cond.value}
//       onChange={(e) => {
//         const val = e.target.value;
//         setConditionsList(prev =>
//           prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//         );
//       }}
//     />
//   );
// })()}
//       </div>
//     ))}
//   </div>
// )}

//             {activeTab === "disableConditions" && (
//   <div>
//     <button className="btn btn-primary mb-2" onClick={addDisableCondition}>
//       + اضف شرط تعطيل
//     </button>

//     {disableConditionsList.map((cond, idx) => (
//       <div key={cond.id} className="card p-2 mb-2">
//         <select
//           className="form-control mb-2"
//           value={cond.fieldId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setDisableConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, fieldId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر الفيلد</option>
//           {pathGroups.flatMap(g => g.fields).map(f => (
//             <option key={f.id} value={f.id}>{f.label}</option>
//           ))}
//         </select>

//         <select
//           className="form-control mb-2"
//           value={cond.conditionTypeId}
//           onChange={(e) => {
//             const val = e.target.value;
//             setDisableConditionsList(prev =>
//               prev.map(c => c.id === cond.id ? { ...c, conditionTypeId: val } : c)
//             );
//           }}
//         >
//           <option value="">اختر نوع الشرط</option>
//           {conditionTypes.map(ct => (
//             <option key={ct.value} value={ct.value}>{ct.text}</option>
//           ))}
//         </select>

//         {/* {!(cond.conditionTypeId === "فارغ" || cond.conditionTypeId === "غير فارغ"||cond.conditionTypeId ==="Not Null"||
//           cond.conditionTypeId ==="Null" ) && (
//           <input
//             type="text"
//             className="form-control"
//             placeholder="ادخل القيمة"
//             value={cond.value}
//             onChange={(e) => {
//               const val = e.target.value;
//               setDisableConditionsList(prev =>
//                 prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//               );
//             }}
//           />
//         )} */}
//         {(() => {
//   const selectedConditionType = conditionTypes.find(ct => ct.value === cond.conditionTypeId);
//   const conditionText = selectedConditionType?.text;

//   return !(conditionText === "فارغ" || conditionText === "غير فارغ" || conditionText === "Not Null" || conditionText === "Null") && (
//     <input
//       type="text"
//       className="form-control"
//       placeholder="ادخل القيمة"
//       value={cond.value}
//       onChange={(e) => {
//         const val = e.target.value;
//         setDisableConditionsList(prev =>
//           prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
//         );
//       }}
//     />
//   );
// })()}

//       </div>
//     ))}
//   </div>
// )}

//         </div></>

//       </div>):null} 

//       <div onClick={()=>{console.log(pathGroups)}}>submit</div>
//     </div>
//   );
// }

// export default PathEditInfo;



























import { v4 as uuidv4 } from "uuid";
import { Api_URL } from '../../Resources/ApiUrl';
import LookUpsFrontdata from '../../Resources/LookUps'
import  { useState ,useEffect } from "react";
import styles from "./PathEditInfo.module.css";

function PathEditInfo() {
  const [openDropdownField, setOpenDropdownField] = useState(null);
  const [activeField, setActiveField] = useState(null);
  const [ActiveGroup, setActiveGroup] = useState(null);
  const [activeTab, setActiveTab] = useState("main");
  const inputFilterList = LookUpsFrontdata.FieldHelper;
  const [fieldSelectList, setfieldSelectList] = useState(null);
  const [chooseSelectField, setchooseSelectField] = useState(false);
const [useCustomLookup, setUseCustomLookup] = useState(false);
const [customOptions, setCustomOptions] = useState([]);
const [newOption, setNewOption] = useState("");

  // --- جديد: حالات لاستخدام خيارات من كيان النظام وجلب بياناته ---
  const [useSystemLookup, setUseSystemLookup] = useState(false); // تم تفعيل خيار استخدام كيانات النظام
  const [selectedSystemLookupKey, setSelectedSystemLookupKey] = useState(""); // ال-key المختار من ApplicationLookUp
  const [systemLookupItems, setSystemLookupItems] = useState([]); // النتيجة الراجعة من ال-API
  const [systemLookupLoading, setSystemLookupLoading] = useState(false);
const [conditionsList, setConditionsList] = useState([]); // كل الشروط المضافة
const [conditionTypes, setConditionTypes] = useState([]); // أنواع الشروط من API

  // وظيفة مساعدة بسيطة لتفادي أخطاء auto-resize إذا كانت مفقودة

  const [disableConditionsList, setDisableConditionsList] = useState([]);

  const isSelectField = activeField?.type === "One Select" 
  || activeField?.type === "MultibelSelect" 
  || activeField?.type === "خيارات متعددة (Select)" 
  || activeField?.type === "اختيار واحد (Select)"
  || activeField?.type === "اختيار واحد (Select)"
  || activeField?.type === "خيارات متعددة (CheckBox)"
  || activeField?.type === "CheckBox Group"
  || activeField?.type === "Radio Button"
  || activeField?.type === "View List"
  || activeField?.type === "قائمة نصية"
  ;
  // هذا ال-state يحتوى إعدادات الحقل (نستخدم عنصر واحد لكل فيلد عند الطلب)
const [pathGroups, setPathGroups] = useState([
    {
      id:  uuidv4(),
      name: "Group",
      viewOrder: 0,
      title:"Group",
      type: null,
      groupFields: [
        {
          id: uuidv4(),
          fieldTypeId: null,
          name: "field 1",
          viewOrder: 0,
          isReadOnly: false,
          isRequired: false,
          isReportExportable: false,
          isForVisitReport: false,
          isForSpecialSammaryReport: false,
          title: "field 1",
          type: null,
          unified: 0,
          isOptionRelatedToEntity: false,
          optionsRelatedToEntityId: null,
          fieldOption: [
            {
              id: null,
              name: null,
              isActive: 0,
              relatedCategoryPathFieldId: null,
              relatedEntityOptionId: null,
              relatedEntityId: null,
              viewOrder: 0,
              showIfCondetionGroup: [
                {
                  id: null,
                  relatedCategoryPathFieldOptionId: null,
                  conditionForId: null,
                  andorOr: false,
                  conditions: [
                    {
                      id: null,
                      fieldId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      relatedCategoryPathFieldId: null,
                      relatedEntityId: null,
                      relatedEntityOptionId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ],
              selectedIfCondetionGroup: [
                {
                  id: null,
                  relatedCategoryPathFieldOptionId: null,
                  conditionForId: null,
                  andorOr: false,
                  conditions: [
                    {
                      id: null,
                      fieldId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      relatedCategoryPathFieldId: null,
                      relatedEntityId: null,
                      relatedEntityOptionId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ],
              disabledIfCondetionGroup: [
                {
                  id: null,
                  relatedCategoryPathFieldOptionId: null,
                  conditionForId: null,
                  andorOr: false,
                  conditions: [
                    {
                      id: null,
                      fieldId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      relatedCategoryPathFieldId: null,
                      relatedEntityId: null,
                      relatedEntityOptionId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ]
            }
          ],
          showIfCondetionGroup: [
            {
              id: null,
              relatedToCategoryPathFieldId: null,
              categoryPathFieldEventGroupId: null,
              conditionForId: null,
              andorOr: false,
              viewOrder: 0,
              conditions: [
                {
                  id: null,
                  fieldConditionGroupId: null,
                  fieldId: null,
                  conditionForId: null,
                  conditionTypeId: null,
                  value: null,
                  andorOr: false,
                  viewOrder: 0,
                  valueList: [null],
                  conditionRelationTypeId: null,
                  categoryPathFieldRelatedEntityFieldId: null
                }
              ]
            }
          ],
          readOnlyIfCondetionGroup: [
            {
              id: null,
              relatedToCategoryPathFieldId: null,
              categoryPathFieldEventGroupId: null,
              conditionForId: null,
              andorOr: false,
              viewOrder: 0,
              conditions: [
                {
                  id: null,
                  fieldConditionGroupId: null,
                  fieldId: null,
                  conditionForId: null,
                  conditionTypeId: null,
                  value: null,
                  andorOr: false,
                  viewOrder: 0,
                  valueList: [null],
                  conditionRelationTypeId: null,
                  categoryPathFieldRelatedEntityFieldId: null
                }
              ]
            }
          ],
          disabledIfCondetionGroup: [
            {
              id: null,
              relatedToCategoryPathFieldId: null,
              categoryPathFieldEventGroupId: null,
              conditionForId: null,
              andorOr: false,
              viewOrder: 0,
              conditions: [
                {
                  id: null,
                  fieldConditionGroupId: null,
                  fieldId: null,
                  conditionForId: null,
                  conditionTypeId: null,
                  value: null,
                  andorOr: false,
                  viewOrder: 0,
                  valueList: [null],
                  conditionRelationTypeId: null,
                  categoryPathFieldRelatedEntityFieldId: null
                }
              ]
            }
          ],
          eventsGroup: [
            {
              id: null,
              events: [
                {
                  id: null,
                  actionTypeId: null,
                  dynamicFunctionId: null,
                  dynamicFunctionIdentifire: null,
                  parameters: [
                    {
                      id: null,
                      name: null,
                      parameterIdentifire: null,
                      parameterId: null,
                      categoryPathFieldId: null,
                      staticValue: null,
                      isRelatedToPathFields: false,
                      fieldShouldRelatedToEntityTypeId: null
                    }
                  ],
                  results: [
                    {
                      id: null,
                      name: null,
                      outputIdentifire: null,
                      resultId: null,
                      categoryPathFieldId: null,
                      isNotification: false,
                      isPathResult: false,
                      isPathValue: false
                    }
                  ],
                  processOrder: 0
                }
              ],
              executeTrigger: {
                additionalProp1: false,
                additionalProp2: false,
                additionalProp3: false
              },
              executeIfCondetionGroup: [
                {
                  id: null,
                  relatedToCategoryPathFieldId: null,
                  categoryPathFieldEventGroupId: null,
                  conditionForId: null,
                  andorOr: false,
                  viewOrder: 0,
                  conditions: [
                    {
                      id: null,
                      fieldConditionGroupId: null,
                      fieldId: null,
                      conditionForId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      conditionRelationTypeId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ],
              andorOr: false,
              processOrder: 0
            }
          ]
        }
      ]
    }
  ])

const [fieldLookupKeys, setFieldLookupKeys] = useState({}); 
  const autoResize = (e) => {
    if (!e || !e.target) return;
    try {
      e.target.style.height = "auto";
      e.target.style.height = `${e.target.scrollHeight}px`;
    } catch (err) { /* noop */ }
  };

   useEffect(() => {
    const fetchFieldTypes = async () => {
      try {
        const entity = LookUpsFrontdata.ApplicationLookUp.find(
          (e) => e.value === "أنواع الحقول"
        );

        if (!entity) return;

        const dto = {
          entityId: entity.key,
          condetion: null,
        };

        const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dto),
        });

        const data = await res.json();

        if (data?.succeeded && data?.data?.items) {
          const mapped = data.data.items.map((c) => ({
            value: c.value,
            text: c.text,
          }));
          setfieldSelectList(mapped);
        }
      } catch (err) {
        console.error(err);
        if (typeof toast !== 'undefined') {
          toast.error("خطأ فالتحميل", {
            position: "top-right",
            style: { backgroundColor: "red", color: "white" },
          });
        }
      }
    };

    fetchFieldTypes();
  }, []);

  // --- جديد: عندما يختار المستخدم كيان من ApplicationLookUp نجيب منه بيانات الـ Lookup ---
  useEffect(() => {
    if (!selectedSystemLookupKey) {
      setSystemLookupItems([]);
      return;
    }

    const fetchSystemLookupItems = async () => {
      setSystemLookupLoading(true);
      try {
        const dto = { entityId: selectedSystemLookupKey, condetion: null };
        const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dto),
        });
        const data = await res.json();
        if (data?.succeeded && data?.data?.items) {
          // نحفظ الـ items عشان نعرضهم في ال-list (نأخذ text و value من كل item)
          setSystemLookupItems(data.data.items.map(it => ({ text: it.text ?? it.value, value: it.value })));
        } else {
          setSystemLookupItems([]);
        }
      } catch (err) {
        console.error(err);
        setSystemLookupItems([]);
        if (typeof toast !== 'undefined') {
          toast.error("خطأ في جلب بيانات الـ Lookup");
        }
      } finally {
        setSystemLookupLoading(false);
      }
    };

    fetchSystemLookupItems();
  }, [selectedSystemLookupKey]);


  useEffect(() => {
    if (!activeField) return;

    const updatedGroup = pathGroups.find((g) =>
      g.groupFields.some((f) => f.id === activeField.id)
    );
    if (!updatedGroup) return;

    const updatedField = updatedGroup.groupFields.find(
      (f) => f.id === activeField.id
    );

    if (updatedField && updatedField.name !== activeField.name) {
      setActiveField(updatedField);
    }
  }, [pathGroups]);



  useEffect(() => {
  const fetchConditionTypes = async () => {
    try {
      const entity = LookUpsFrontdata.ApplicationLookUp.find(
        (e) => e.value === "أنواع الشروط"
      );
      if (!entity) return;

      const dto = { entityId: entity.key, condetion: null };
      const res = await fetch(`${Api_URL}/CP/v1.0/Lookup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dto),
      });
      const data = await res.json();

      if (data?.succeeded && data?.data?.items) {
        setConditionTypes(data.data.items.map(c => ({ value: c.value, text: c.text })));
      }
    } catch (err) {
      console.error(err);
    }
  };

  fetchConditionTypes();
}, []);


// useEffect(() => {
//   if (activeField && selectedSystemLookupKey && systemLookupItems.length > 0) {
//     handleSelectSystemLookup(activeField.id, selectedSystemLookupKey, systemLookupItems);
//   }
//   else if(activeField && !selectedSystemLookupKey){
//         setPathGroups(prev =>
//         prev.map(group => ({
//           ...group,
//           groupFields: group.groupFields.map(field =>
//             field.id === activeField.id
//               ? {
//                   ...field,
//                   isOptionRelatedToEntity: false,
//                   isActive:0,
//                   optionsRelatedToEntityId: null,
//                   fieldOption: [], 
//                 }
//               : field
//           ),
//         }))
//       );
//   }
// }, [systemLookupItems, activeField, selectedSystemLookupKey]);

let generateEmptyField = (count) => 
  {
    return {
          id:  uuidv4(),
          fieldTypeId: null,
          name: "field 1",
          viewOrder: count  || 0,
          isReadOnly: false,
          isRequired: false,
          isReportExportable: false,
          isForVisitReport: false,
          isForSpecialSammaryReport: false,
          title: null,
          type: null,
          unified: 0,
          isOptionRelatedToEntity: false,
          optionsRelatedToEntityId: null,
          fieldOption: [
            {
              id: null,
              name: null,
              isActive: 0,
              relatedCategoryPathFieldId: null,
              relatedEntityOptionId: null,
              relatedEntityId: null,
              viewOrder: 0,
              showIfCondetionGroup: [
                {
                  id: null,
                  relatedCategoryPathFieldOptionId: null,
                  conditionForId: null,
                  andorOr: false,
                  conditions: [
                    {
                      id: null,
                      fieldId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      relatedCategoryPathFieldId: null,
                      relatedEntityId: null,
                      relatedEntityOptionId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ],
              selectedIfCondetionGroup: [
                {
                  id: null,
                  relatedCategoryPathFieldOptionId: null,
                  conditionForId: null,
                  andorOr: false,
                  conditions: [
                    {
                      id: null,
                      fieldId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      relatedCategoryPathFieldId: null,
                      relatedEntityId: null,
                      relatedEntityOptionId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ],
              disabledIfCondetionGroup: [
                {
                  id: null,
                  relatedCategoryPathFieldOptionId: null,
                  conditionForId: null,
                  andorOr: false,
                  conditions: [
                    {
                      id: null,
                      fieldId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      relatedCategoryPathFieldId: null,
                      relatedEntityId: null,
                      relatedEntityOptionId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ]
            }
          ],
          showIfCondetionGroup: [
            {
              id: null,
              relatedToCategoryPathFieldId: null,
              categoryPathFieldEventGroupId: null,
              conditionForId: null,
              andorOr: false,
              viewOrder: 0,
              conditions: [
                {
                  id: null,
                  fieldConditionGroupId: null,
                  fieldId: null,
                  conditionForId: null,
                  conditionTypeId: null,
                  value: null,
                  andorOr: false,
                  viewOrder: 0,
                  valueList: [null],
                  conditionRelationTypeId: null,
                  categoryPathFieldRelatedEntityFieldId: null
                }
              ]
            }
          ],
          readOnlyIfCondetionGroup: [
            {
              id: null,
              relatedToCategoryPathFieldId: null,
              categoryPathFieldEventGroupId: null,
              conditionForId: null,
              andorOr: false,
              viewOrder: 0,
              conditions: [
                {
                  id: null,
                  fieldConditionGroupId: null,
                  fieldId: null,
                  conditionForId: null,
                  conditionTypeId: null,
                  value: null,
                  andorOr: false,
                  viewOrder: 0,
                  valueList: [null],
                  conditionRelationTypeId: null,
                  categoryPathFieldRelatedEntityFieldId: null
                }
              ]
            }
          ],
          disabledIfCondetionGroup: [
            {
              id: null,
              relatedToCategoryPathFieldId: null,
              categoryPathFieldEventGroupId: null,
              conditionForId: null,
              andorOr: false,
              viewOrder: 0,
              conditions: [
                {
                  id: null,
                  fieldConditionGroupId: null,
                  fieldId: null,
                  conditionForId: null,
                  conditionTypeId: null,
                  value: null,
                  andorOr: false,
                  viewOrder: 0,
                  valueList: [null],
                  conditionRelationTypeId: null,
                  categoryPathFieldRelatedEntityFieldId: null
                }
              ]
            }
          ],
          eventsGroup: [
            {
              id: null,
              events: [
                {
                  id: null,
                  actionTypeId: null,
                  dynamicFunctionId: null,
                  dynamicFunctionIdentifire: null,
                  parameters: [
                    {
                      id: null,
                      name: null,
                      parameterIdentifire: null,
                      parameterId: null,
                      categoryPathFieldId: null,
                      staticValue: null,
                      isRelatedToPathFields: false,
                      fieldShouldRelatedToEntityTypeId: null
                    }
                  ],
                  results: [
                    {
                      id: null,
                      name: null,
                      outputIdentifire: null,
                      resultId: null,
                      categoryPathFieldId: null,
                      isNotification: false,
                      isPathResult: false,
                      isPathValue: false
                    }
                  ],
                  processOrder: 0
                }
              ],
              executeTrigger: {
                additionalProp1: false,
                additionalProp2: false,
                additionalProp3: false
              },
              executeIfCondetionGroup: [
                {
                  id: null,
                  relatedToCategoryPathFieldId: null,
                  categoryPathFieldEventGroupId: null,
                  conditionForId: null,
                  andorOr: false,
                  viewOrder: 0,
                  conditions: [
                    {
                      id: null,
                      fieldConditionGroupId: null,
                      fieldId: null,
                      conditionForId: null,
                      conditionTypeId: null,
                      value: null,
                      andorOr: false,
                      viewOrder: 0,
                      valueList: [null],
                      conditionRelationTypeId: null,
                      categoryPathFieldRelatedEntityFieldId: null
                    }
                  ]
                }
              ],
              andorOr: false,
              processOrder: 0
            }
          ]
        }
      
  }




  let HandleFieldTypeSelect = (e) => {
    const selectedValue = e.target.value;   // value من الـ option
    const selectedText = e.target.options[e.target.selectedIndex].text; // النص الظاهر

    if (selectedText === "One Select" || selectedText === "MultibelSelect" || selectedText === "خيارات متعددة (Select)" || selectedText === "اختيار واحد (Select)") {
      setchooseSelectField(true);
    } else {
       setchooseSelectField(false);
    }

    // نحدث ال-pathGroups بنفس التغيير
    setPathGroups((prev) =>
      prev.map((group) => ({
        ...group,
        groupFields: group.groupFields.map((field) =>
          field.id === activeField?.id
            ? { ...field, fieldTypeId: selectedValue, type: selectedText }
            : field
        ),
      }))
    );

setActiveField((prev) => ({
  ...prev,
  fieldTypeId: selectedValue,
  type: selectedText,
}));

  }
const handleSelectSystemLookup = (fieldId, lookupKey = null, lookupItems = [], customOptions = []) => {
  setPathGroups(prev =>
    prev.map(group => ({
      ...group,
      groupFields: group.groupFields.map(field => {
        if (field.id !== fieldId) return field;

        // بناء خيارات النظام
        const systemOptions = lookupItems.map((item, index) => ({
          id: uuidv4(),
          name: item.text,
          isActive: 1,
          relatedCategoryPathFieldId: null,
          relatedEntityOptionId: field,
          relatedEntityId: field.id,
          viewOrder: index,
          showIfCondetionGroup: [],
          selectedIfCondetionGroup: [],
          disabledIfCondetionGroup: [],
        }));

        // بناء خيارات المخصص
        const customOpts = customOptions.map((c, i) => ({
          id: uuidv4(),
          name: c.text,
          isActive: 1,
          relatedCategoryPathFieldId: null,
          relatedEntityOptionId: null,
          relatedEntityId: field.id,
          viewOrder: (field.fieldOption?.length || 0) + i,
          showIfCondetionGroup: [],
          selectedIfCondetionGroup: [],
          disabledIfCondetionGroup: [],
        }));

        return {
          ...field,
          isOptionRelatedToEntity: !!lookupKey,
          optionsRelatedToEntityId: lookupKey,
          fieldOption: lookupKey
            ? [...systemOptions, ...customOpts]       // لو اختيار من النظام → نستبدل
            : [...(field.fieldOption || []), ...customOpts], // لو مخصص → نضيف
        };
      }),
    }))
  );
};


  const addCondition = () => {
  setConditionsList(prev => [
    ...prev,
    { id: Date.now(), fieldId: "", conditionTypeId: "", value: "" }
  ]);
};

const addDisableCondition = () => {
  setDisableConditionsList(prev => [
    ...prev,
    { id: Date.now(), fieldId: "", conditionTypeId: "", value: "" }
  ]);
};

  // إضافة جروب
  const addGroup = () => {

    // نضيف جروب فارغ في pathGroups
     setPathGroups((prev) => [
    ...prev,
    {
      id: uuidv4(),
      name: `Group`,
      viewOrder: prev.length,
      title: `Group`,
      type: null,
            groupFields: [
     generateEmptyField(0)
      ]
    }
  ]);


  };

 
  // تعديل اسم الجروب
  const handleGroupNameChange = (groupId, newName) => {
    console.log("Changing group name:", groupId, newName);
         setPathGroups(prev =>
  prev.map((g) =>
    g.id === groupId ? { ...g, name: newName } : g
  )
);

  };

  // إضافة فيلد
  const addField = () => {
  setPathGroups((prev) => {
    if (prev.length === 0) {
      // أول Group فاضي → نضيفه ونحط فيه Field
      const newGroup = {
        id: uuidv4(),
        name: "Group 1",
        viewOrder: 0,
        title: "Group 1",
        type: null,
        groupFields: [generateEmptyField(0)]
      };
      return [newGroup];
    }
    // عندنا Group موجود → نزود Field جديد في أول Group
    return prev.map((g, idx) => {
      if (idx !== 0) return g;

      // حساب الترتيب الجديد بناءً على عدد الفيلدات الحالية في الجروب ده
      const newFields = [...g.groupFields, generateEmptyField(g.groupFields.length)];

      // نضمن ترتيب viewOrder متسلسل من 0..n-1
      const reOrdered = newFields.map((f, i) => ({ ...f, viewOrder: i }));

      return { ...g, groupFields: reOrdered };
    });

  });
};

const handleFieldLabelChange = (groupId, fieldId, newLabel,newKey) => {
  setPathGroups((prev) =>
    prev.map((g) =>
      g.id === groupId
        ? {
            ...g,
            groupFields: g.groupFields.map((f) =>
              f.id === fieldId ? { ...f, name: newLabel,id:newKey?newKey:f.id } : f
            ),
          }
        : g
    )
  );

  // تحديث الـ ActiveField
  setActiveField((af) => {
    // لو الـ activeField الحالي مش هو نفس الفيلد، ممكن نسيبه زي ما هو
    if (af && af.id !== fieldId) return af;

    // لو مفيش activeField أو هو نفس الفيلد، هنعيده كامل
    let updatedField = null;
    setPathGroups((latest) => {
      const grp = latest.find((g) => g.id === groupId);
      if (grp) {
        updatedField = grp.groupFields.find((f) => f.id === (newKey?newKey:fieldId));
      }
      return latest;
    });

    return updatedField || af;
  });

};

const handleCheckboxChange = (propName) => (e) => {

  const value = e.target.checked;

  setActiveField((prev) => ({
    ...prev,
    [propName]: e.target.checked
  }));

setPathGroups((prev) =>
    prev.map((group) => ({
      ...group,
      groupFields: group.groupFields.map((field) =>
        field.id === activeField?.id
          ? { ...field, [propName]: value }
          : field
      ),
    }))
  );
};

  // // Drag Start
  const handleDragStart = (e, fieldId, fromGroupId) => {
    const payload = JSON.stringify({ fieldId, fromGroupId });
    e.dataTransfer.setData("text/plain", payload);
    e.dataTransfer.effectAllowed = "move";
  };


const handleDrop = (e, targetGroupId) => {
  e.preventDefault();
  const raw = e.dataTransfer.getData("text/plain");
  if (!raw) return;

  let obj;
  try {
    obj = JSON.parse(raw);
  } catch {
    return;
  }

  const { fieldId, fromGroupId } = obj;
  if (fromGroupId === targetGroupId) return;

  setPathGroups((prev) => {
    let fieldObj = null;

    // شيل الفيلد من الجروب الأصلي
    const removed = prev.map((g) => {
      if (g.id === fromGroupId) {
        const filtered = g.groupFields.filter((f) => {
          if (f.id === fieldId) {
            fieldObj = f;
            return false;
          }
          return true;
        });

        // رتب الأوردر بعد الحذف
        const reOrdered = filtered.map((f, idx) => ({
          ...f,
          viewOrder: idx,
        }));

        return { ...g, groupFields: reOrdered };
      }
      return g;
    });

    if (!fieldObj) return prev;

    // ضيف الفيلد في الجروب الهدف
    return removed.map((g) => {
      if (g.id === targetGroupId) {
        const newFields = [...g.groupFields, { ...fieldObj }];

        // رتب الأوردر بعد الإضافة
        const reOrdered = newFields.map((f, idx) => ({
          ...f,
          viewOrder: idx,
        }));

        return { ...g, groupFields: reOrdered };
      }
      return g;
    });
  });
};


  // // حذف جروب
  const deleteGroup = (groupId) => {
    setPathGroups((prev) => prev.filter((g) => g.id !== groupId));
  };

  
  // // حذف فيلد
  const deleteField = (groupId, fieldId) => {
setPathGroups((prev) =>
    prev.map((g) =>
      g.id === groupId
        ? {
            ...g,
            groupFields: g.groupFields.filter((f) => f.id !== fieldId),
          }
        : g
    )
  );
  // لو الفيلد المتحدد activeField هو نفسه اللي اتمسح رجعه null
  setActiveField((af) => (af && af.id === fieldId ? null : af));
  };


const addOption = (option, fromSystem = false) => {
  setPathGroups((prev) =>
    prev.map((group) => ({
      ...group,
      groupFields: group.groupFields.map((field) =>
        field.id === activeField?.id
          ? {
              ...field,
              fieldOption: [
                ...field.fieldOption,
                {
                  id: fromSystem ? option.id : uuidv4(),    
                  name: option.text || option.name || option.value,
                  isActive: 1,
                  relatedCategoryPathFieldId: null,
                  relatedEntityOptionId: null,
                  relatedEntityId: null,
                  viewOrder:field.fieldOption.length===0?0: field.fieldOption.length-1,       // ترتيب حسب الطول الحالي
                  showIfCondetionGroup: [],
                  selectedIfCondetionGroup: [],
                  disabledIfCondetionGroup: [],
                },
              ],
            }
          : field
      ),
    }))
  );
};

  // currentGroupField للمساعدة عند عرض select نوع الحقل
  // const currentGroupField = groupFields.find(f => f.id === activeField?.id) || groupFields[0];

  return (
    <div className={styles.container}>
      {/* العمود الشمال */}
      <div className={styles.left}>
        <div className={styles.groupsPanel}>
          <div className={styles.actions}>
            <button onClick={addGroup} className={styles.addButton}>+ New Group</button>
            <button onClick={addField} className={styles.addButton}>+ New Field</button>
          </div>

          <div className={styles.groupsList}>
            {pathGroups.map((group) => (
              <div
                key={group.id}               
                className={styles.groupBox}
                onDragOver={(e) => e.preventDefault()}
                onDrop={(e) => handleDrop(e, group.id)}
              >
                <div className={styles.groupHeader}>
                  <input
                    type="text"
                    value={group.name}
                    onChange={(e) => {handleGroupNameChange(group.id, e.target.value); autoResize(e);} }
                    className={styles.groupNameInput}
                  />
                  <button className={styles.deleteBtn} onClick={() => deleteGroup(group.id)}><i className="bi bi-trash-fill fs-3"></i></button>
                </div>

                <ul className={styles.fieldsUl}>
                  {group.groupFields.map((field) => (
                    <li
                      key={field.id}
                      className={styles.fieldItem}
                      draggable
                      onDragStart={(e) => handleDragStart(e, field.id, group.id)}
                       onClick={() => {
    setOpenDropdownField(null);
  setActiveField(field);

  }}
                    >
                      <span className={styles.dragHandle} aria-hidden>≡</span>
                       <div className={styles.fieldWithDropdown}>
                      <input
                        type="text"
                        value={field.name}
                        onChange={(e) => {handleFieldLabelChange(group.id, field.id, e.target.value);  
                          autoResize(e);
                         setOpenDropdownField(field.id);
                        } }
                        className={styles.fieldInput}
                        draggable={false}
                      />
                            {/* suggestions */}
      {openDropdownField && openDropdownField === field.id && (
        <ul className={styles.suggestions}>
          {inputFilterList
            .filter((item) =>
              item.value.toLowerCase().includes(field.name.toLowerCase())
            )
            .map((item) => (
              <li
                key={item.key}
                onClick={(e) =>{
                  e.stopPropagation();
                  handleFieldLabelChange(group.id, field.id, item.value,item.key);
                  setActiveField((prev) =>
    prev?.id === field.id
      ? { ...prev, name: item.value, id: item.key }
      : prev
  ); 
                  setOpenDropdownField(null);} }
                className={styles.suggestionItem}
              >
                {item.value}
              </li>
            ))}
        </ul>
      )}
    </div>
                      <button
                        className={styles.deleteBtn}
                        onClick={(e) => {
                          e.stopPropagation();
                          deleteField(group.id, field.id);
                        }}
                      >❌</button>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* العمود اليمين */}
     {activeField ? (  <div className={styles.right}>
        <> <div className={styles.navbar}>
          <button className={activeTab === "main" ? styles.activeBtn : ""} onClick={() => setActiveTab("main")}>
            الصفحة الرئيسية
            </button>
          <button className={activeTab === "fieldOptions" ? styles.activeBtn : ""} onClick={() => setActiveTab("fieldOptions")}>
            خيارات الحقل
            </button>
          <button className={activeTab === "conditions" ? styles.activeBtn : ""} onClick={() => setActiveTab("conditions")}>شروط الإظهار</button>
             <button
      className={activeTab === "disableConditions" ? styles.activeBtn : ""}
      onClick={() => setActiveTab("disableConditions")}
    >
      شروط التعطيل
    </button>
        </div>

        <div className={styles.tabContent}>
          {activeTab === "main" && (
            <div>
              <p>العنوان</p>
              <input
                type="text"
                className={styles.input}
                value={activeField ? activeField.name : ""}
              />
              <p className='mt-2'>النوع</p>
<select
  className={styles.input}
  value={activeField?.fieldTypeId ?? ""}
  onChange={HandleFieldTypeSelect}
>
  <option value="">اختر نوع الحقل</option>
  {fieldSelectList?.map((item) => (
    <option key={item.value} value={item.value}>
      {item.text}
    </option>
  ))}
</select>

                  <div className={`mt-3 ${styles.checkboxGroup}`}>
      <label>
        <input type="checkbox"     onChange={handleCheckboxChange("isRequired")}     checked={activeField?.isRequired || false} />
        هل الحقل إجباري عند ظهور المسار؟
      </label>
      <br />
      <label>
        <input type="checkbox"     checked={activeField?.isReadOnly || false}
    onChange={handleCheckboxChange("isReadOnly")} />
        هل الحقل للقراءة فقط؟
      </label>
      <br />
           <label>
        <input type="checkbox"    checked={activeField?.isReportExportable || false}
    onChange={handleCheckboxChange("isReportExportable")}  />
        هل الحقل قابل للتصدير فالتقارير؟
      </label>
    </div>

            </div>
          )}







{activeTab === "fieldOptions" && (
  <div>
    {isSelectField ? (
      <div className="container">
        <h4>فقط اختر نوع من انواع النظام</h4>
        <div className="row">
          <div className="col-6">
            <label>
              <input
                type="radio"
                name="lookupOption"
                checked={useSystemLookup}
                onChange={() => {
                  setUseSystemLookup(true);
                  setSelectedSystemLookupKey('');
                  if (activeField) {
                    setPathGroups(prev =>
                      prev.map(group => ({
                        ...group,
                        groupFields: group.groupFields.map(field =>
                          field.id === activeField.id
                            ? { ...field, fieldOption: [] }
                            : field
                        ),
                      }))
                    );
                  }
                }}
              />
              خيارات من كيان النظام
            </label>
          </div>
          <div className="col-6">
            <label>
              <input
                type="radio"
                name="lookupOption"
                checked={!useSystemLookup}
                onChange={() => {
                  setUseSystemLookup(false);
                  setSelectedSystemLookupKey('');
                  if (activeField) {
                    setPathGroups(prev =>
                      prev.map(group => ({
                        ...group,
                        groupFields: group.groupFields.map(field =>
                          field.id === activeField.id
                            ? { ...field, fieldOption: [] }
                            : field
                        ),
                      }))
                    );
                  }
                }}
              />
              خيارات مخصصه
            </label>
          </div>
        </div>

        {useSystemLookup && (
       <div className="col-12 mt-2">
    <label>اختر كيان من بيان النظام</label>
<select
  className="form-control mt-2"
  value={activeField?.optionsRelatedToEntityId || ""}
  onChange={(e) => {
    const key = e.target.value;

    handleSelectSystemLookup(
      activeField.id,
      key,
      systemLookupItems,
      []
    );
  }}
>
  <option value="">-- اختر --</option>
  {LookUpsFrontdata.ApplicationLookUp.map(item => (
    <option key={item.key} value={item.key}>{item.value}</option>
  ))}
</select>


  </div>
        )}

        {/* عرض كل الخيارات الخاصة بالحقل فقط */}
        <div className={`col-12 container ${styles.listScroll} mt-3`}>
          {activeField?.fieldOption?.length === 0 ? (
            <div className="text-muted">لا توجد بيانات</div>
          ) : (
            activeField.fieldOption.map((opt, idx) => (
              <div key={idx} className="list-group-item">
                <strong>{opt.name}</strong>
                <button
                  className="btn btn-sm ms-3"
                  onClick={() => {
                    setPathGroups(prev =>
                      prev.map(group => ({
                        ...group,
                        groupFields: group.groupFields.map(field =>
                          field.id === activeField.id
                            ? {
                                ...field,
                                fieldOption: field.fieldOption.filter((_, i) => i !== idx),
                              }
                            : field
                        ),
                      }))
                    );
                  }}
                >
                  🗑
                </button>
              </div>
            ))
          )}
        </div>

        {/* اضافة خيار جديد */}
        <input
          type="text"
          placeholder="اضافة خيار جديد"
          className={styles.input}
          value={newOption}
          onChange={(e) => setNewOption(e.target.value)}
        />
        <button
          className="btn btn-primary mt-2"
           onClick={() => {
    <button
  className="btn btn-primary mt-2"
  onClick={() => {
    if (newOption.trim() && activeField) {
      handleSelectSystemLookup(
        activeField.id,
        useSystemLookup ? activeField.optionsRelatedToEntityId : null,
        useSystemLookup ? systemLookupItems : [],
        [{ text: newOption }]
      );
      setNewOption("");
    }
  }}
>
  اضافه
</button>

  }}
        >
          اضافه
        </button>
      </div>
    ) : (
      "لا يوجد اختيارات لهذا الحقل"
    )}
  </div>
)}













          
{activeTab === "conditions" && (
  <div>
    <button className="btn btn-primary mb-2" onClick={addCondition}>
      + اضف شرط
    </button>

    {conditionsList.map((cond, idx) => (
      <div key={cond.id} className="card p-2 mb-2">
        {/* اختيار الفيلد */}
        <select
          className="form-control mb-2"
          value={cond.fieldId}
          onChange={(e) => {
            const val = e.target.value;
            setConditionsList(prev =>
              prev.map(c => c.id === cond.id ? { ...c, fieldId: val } : c)
            );
          }}
        >
          <option value="">اختر الفيلد</option>
          {pathGroups.flatMap(g => g.fields).map(f => (
            <option key={f.id} value={f.id}>{f.label}</option>
          ))}
        </select>

        {/* اختيار نوع الشرط */}
        <select
          className="form-control mb-2"
          value={cond.conditionTypeId}
          onChange={(e) => {
            const val = e.target.value;
            setConditionsList(prev =>
              prev.map(c => c.id === cond.id ? { ...c, conditionTypeId: val } : c)
            );
          }}
        >
          <option value="">اختر نوع الشرط</option>
          {conditionTypes.map(ct => (
            <option key={ct.value} value={ct.value}>{ct.text}</option>
          ))}
        </select>

        {(() => {
  const selectedConditionType = conditionTypes.find(ct => ct.value === cond.conditionTypeId);
  const conditionText = selectedConditionType?.text;

  return !(conditionText === "فارغ" || conditionText === "غير فارغ" || conditionText === "Not Null" || conditionText === "Null") && (
    <input
      type="text"
      className="form-control"
      placeholder="ادخل القيمة"
      value={cond.value}
      onChange={(e) => {
        const val = e.target.value;
        setConditionsList(prev =>
          prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
        );
      }}
    />
  );
})()}
      </div>
    ))}
  </div>
)}

            {activeTab === "disableConditions" && (
  <div>
    <button className="btn btn-primary mb-2" onClick={addDisableCondition}>
      + اضف شرط تعطيل
    </button>

    {disableConditionsList.map((cond, idx) => (
      <div key={cond.id} className="card p-2 mb-2">
        <select
          className="form-control mb-2"
          value={cond.fieldId}
          onChange={(e) => {
            const val = e.target.value;
            setDisableConditionsList(prev =>
              prev.map(c => c.id === cond.id ? { ...c, fieldId: val } : c)
            );
          }}
        >
          <option value="">اختر الفيلد</option>
          {pathGroups.flatMap(g => g.fields).map(f => (
            <option key={f.id} value={f.id}>{f.label}</option>
          ))}
        </select>

        <select
          className="form-control mb-2"
          value={cond.conditionTypeId}
          onChange={(e) => {
            const val = e.target.value;
            setDisableConditionsList(prev =>
              prev.map(c => c.id === cond.id ? { ...c, conditionTypeId: val } : c)
            );
          }}
        >
          <option value="">اختر نوع الشرط</option>
          {conditionTypes.map(ct => (
            <option key={ct.value} value={ct.value}>{ct.text}</option>
          ))}
        </select>

        {(() => {
  const selectedConditionType = conditionTypes.find(ct => ct.value === cond.conditionTypeId);
  const conditionText = selectedConditionType?.text;

  return !(conditionText === "فارغ" || conditionText === "غير فارغ" || conditionText === "Not Null" || conditionText === "Null") && (
    <input
      type="text"
      className="form-control"
      placeholder="ادخل القيمة"
      value={cond.value}
      onChange={(e) => {
        const val = e.target.value;
        setDisableConditionsList(prev =>
          prev.map(c => c.id === cond.id ? { ...c, value: val } : c)
        );
      }}
    />
  );
})()}

      </div>
    ))}
  </div>
)}

        </div></>

      </div>):null} 

      <div onClick={()=>{console.log(pathGroups)}}>submit</div>
    </div>
  );
}

export default PathEditInfo;






{activeTab === "fieldOptions" && (
  <div>
    {isSelectField ? (
      <div className="container">
        <h4>فقط اختر نوع من انواع النظام</h4>
        <div className="row">
          <div className="col-6">
            <label>
              <input
                type="radio"
                name="lookupOption"
                checked={useSystemLookup}
                onChange={() => {
                  setUseSystemLookup(true);
                  setSelectedSystemLookupKey('');
                  if (activeField) {
                    setPathGroups(prev =>
                      prev.map(group => ({
                        ...group,
                        groupFields: group.groupFields.map(field =>
                          field.id === activeField.id
                            ? { ...field, fieldOption: [] }
                            : field
                        ),
                      }))
                    );
                  }
                }}
              />
              خيارات من كيان النظام
            </label>
          </div>
          <div className="col-6">
            <label>
              <input
                type="radio"
                name="lookupOption"
                checked={!useSystemLookup}
                onChange={() => {
                  setUseSystemLookup(false);
                  setSelectedSystemLookupKey('');
                  if (activeField) {
                    setPathGroups(prev =>
                      prev.map(group => ({
                        ...group,
                        groupFields: group.groupFields.map(field =>
                          field.id === activeField.id
                            ? { ...field, fieldOption: [] }
                            : field
                        ),
                      }))
                    );
                  }
                }}
              />
              خيارات مخصصه
            </label>
          </div>
        </div>

        {useSystemLookup && (
       <div className="col-12 mt-2">
    <label>اختر كيان من بيان النظام</label>
<select
  className="form-control mt-2"
  value={activeField?.optionsRelatedToEntityId || ""}
  onChange={(e) => {
    const key = e.target.value;

    handleSelectSystemLookup(
      activeField.id,
      key,
      systemLookupItems,
      []
    );
  }}
>
  <option value="">-- اختر --</option>
  {LookUpsFrontdata.ApplicationLookUp.map(item => (
    <option key={item.key} value={item.key}>{item.value}</option>
  ))}
</select>

  </div>
        )}

        {/* عرض كل الخيارات الخاصة بالحقل فقط */}
        <div className={`col-12 container ${styles.listScroll} mt-3`}>
          {activeField?.fieldOption?.length === 0 ? (
            <div className="text-muted">لا توجد بيانات</div>
          ) : (
            activeField.fieldOption.map((opt, idx) => (
              <div key={idx} className="list-group-item">
                <strong>{opt.name}</strong>
                <button
                  className="btn btn-sm ms-3"
                  onClick={() => {
                    setPathGroups(prev =>
                      prev.map(group => ({
                        ...group,
                        groupFields: group.groupFields.map(field =>
                          field.id === activeField.id
                            ? {
                                ...field,
                                fieldOption: field.fieldOption.filter((_, i) => i !== idx),
                              }
                            : field
                        ),
                      }))
                    );
                  }}
                >
                  🗑
                </button>
              </div>
            ))
          )}
        </div>

        {/* اضافة خيار جديد */}
        <input
          type="text"
          placeholder="اضافة خيار جديد"
          className={styles.input}
          value={newOption}
          onChange={(e) => setNewOption(e.target.value)}
        />
        <button
          className="btn btn-primary mt-2"
           onClick={() => {
    if (newOption.trim() && activeField) {
      // 1️⃣ إضافة خيارات النظام لو مفعل
      if (useSystemLookup && selectedSystemLookupKey) {
        handleSelectSystemLookup(
          activeField.id,
          selectedSystemLookupKey,
          systemLookupItems,
          [] // هنا لا مخصص
        );
      }

      // 2️⃣ إضافة الخيار المخصص اللي كتبه المستخدم
      if (!useSystemLookup && newOption.trim()) {
        handleSelectSystemLookup(
          activeField.id,
          null,
          [], // لا نظام
          [{ text: newOption }] // خيار مخصص واحد
        );
      }

      // 3️⃣ حالة المزيج لو حابب تضيف النظام والمخصص مع بعض
      if (useSystemLookup && newOption.trim()) {
        handleSelectSystemLookup(
          activeField.id,
          selectedSystemLookupKey,
          systemLookupItems,
          [{ text: newOption }] // الخيار المخصص مع النظام
        );
      }

      // مسح input بعد الإضافة
      setNewOption("");
    }
  }}
        >
          اضافه
        </button>
      </div>
    ) : (
      "لا يوجد اختيارات لهذا الحقل"
    )}
  </div>
)}



// {activeTab === "fieldOptions" && (
//   <div>
//     {isSelectField ? (
//       <div className="container">
//         <h4>فقط اختر نوع من انواع النظام</h4>

//         <div className="row">
//           <div className="col-6">
//             <label>
//               <input
//                 type="radio"
//                 name="lookupOption"
//                 checked={useSystemLookup}
//                 onChange={() => {
//                   setUseSystemLookup(true);
//                   setSelectedSystemLookupKey("");
//                   setSystemLookupItems([]);
//                   if (activeField) {
//                     setPathGroups((prev) =>
//                       prev.map((group) => ({
//                         ...group,
//                         groupFields: group.groupFields.map((field) =>
//                           field.id === activeField.id
//                             ? { ...field, fieldOption: [] }
//                             : field
//                         ),
//                       }))
//                     );
//                   }
//                 }}
//               />
//               خيارات من كيان النظام
//             </label>
//           </div>

//           <div className="col-6">
//             <label>
//               <input
//                 type="radio"
//                 name="lookupOption"
//                 checked={!useSystemLookup}
//                 onChange={() => {
//                   setUseSystemLookup(false);
//                   setSelectedSystemLookupKey("");
//                   setSystemLookupItems([]);
//                   if (activeField) {
//                     setPathGroups((prev) =>
//                       prev.map((group) => ({
//                         ...group,
//                         groupFields: group.groupFields.map((field) =>
//                           field.id === activeField.id
//                             ? { ...field, fieldOption: [] }
//                             : field
//                         ),
//                       }))
//                     );
//                   }
//                 }}
//               />
//               خيارات مخصصه
//             </label>
//           </div>
//           <br />
//         </div>

//         {/* Select لاختيار كيان النظام */}
//         {useSystemLookup && (
//           <div className="col-12 mt-2">
//             <label>اختر كيان من بيان النظام</label>
//             <select
//               className="form-control mt-2"
//               value={selectedSystemLookupKey}
//               onChange={(e) => {
//                 const key = e.target.value;
//                 setSelectedSystemLookupKey(key);
//                 if (activeField) {
//                   handleSelectSystemLookup(
//                     activeField.id,
//                     key,
//                     systemLookupItems,
//                     customOptions
//                   );
//                 }
//               }}
//             >
//               <option value="">-- اختر --</option>
//               {LookUpsFrontdata.ApplicationLookUp.map((item) => (
//                 <option key={item.key} value={item.key}>
//                   {item.value}
//                 </option>
//               ))}
//             </select>

//             {/* عرض خيارات النظام أو رسالة لا توجد بيانات */}
//             <div className="mt-2">
//               {systemLookupLoading ? (
//                 <div>جاري التحميل ...</div>
//               ) : (
//                 <div className={styles.listScroll}>
//                   {activeField?.fieldOption?.length > 0 ? (
//                     activeField.fieldOption.map((it, idx) => (
//                       <div key={idx} className="list-group-item">
//                         <strong>{it.name}</strong>
//                         <button
//                           className="btn btn-sm ms-3"
//                           onClick={() => {
//                             setPathGroups((prev) =>
//                               prev.map((group) => ({
//                                 ...group,
//                                 groupFields: group.groupFields.map((field) =>
//                                   field.id === activeField.id
//                                     ? {
//                                         ...field,
//                                         fieldOption: field.fieldOption.filter(
//                                           (_, i) => i !== idx
//                                         ),
//                                       }
//                                     : field
//                                 ),
//                               }))
//                             );
//                           }}
//                         >
//                           🗑
//                         </button>
//                       </div>
//                     ))
//                   ) : systemLookupItems.length === 0 ? (
//                     <div className="text-muted">لا توجد بيانات</div>
//                   ) : (
//                     systemLookupItems.map((it, idx) => (
//                       <div key={idx} className="list-group-item">
//                         <strong>{it.text}</strong>
//                         <button
//                           className="btn btn-sm ms-3"
//                           onClick={() => {
//                             setSystemLookupItems((prev) =>
//                               prev.filter((_, i) => i !== idx)
//                             );
//                           }}
//                         >
//                           🗑
//                         </button>
//                       </div>
//                     ))
//                   )}
//                 </div>
//               )}
//             </div>
//           </div>
//         )}

//         {/* عرض الخيارات المخصصة */}
//         {customOptions.length > 0 && (
//           <div className={`col-12 container ${styles.listScroll} mt-3`}>
//             {customOptions.map((it, idx) => (
//               <div key={idx} className="list-item-group">
//                 <strong>{it.text}</strong>
//                 <button
//                   className="btn btn-sm ms-3"
//                   onClick={() => {
//                     setPathGroups((prev) =>
//                       prev.map((group) => ({
//                         ...group,
//                         groupFields: group.groupFields.map((field) =>
//                           field.id === activeField.id
//                             ? {
//                                 ...field,
//                                 fieldOption: field.fieldOption.filter(
//                                   (_, i) => i !== idx
//                                 ),
//                               }
//                             : field
//                         ),
//                       }))
//                     );
//                   }}
//                 >
//                   🗑
//                 </button>
//               </div>
//             ))}
//           </div>
//         )}

//         {/* إضافة خيار جديد */}
//         <input
//           type="text"
//           placeholder="اضافة خيار جديد"
//           className={styles.input}
//           value={newOption}
//           onChange={(e) => setNewOption(e.target.value)}
//         />
//         <button
//           className="btn btn-primary mt-2"
//           onClick={() => {
//             if (newOption.trim() && activeField) {
//               handleSelectSystemLookup(
//                 activeField.id,
//                 useSystemLookup ? selectedSystemLookupKey : null,
//                 useSystemLookup ? systemLookupItems : [],
//                 !useSystemLookup ? customOptions : []
//               );
//               setNewOption("");
//             }
//           }}
//         >
//           اضافه
//         </button>
//       </div>
//     ) : (
//       "لا يوجد اختيارات لهذا الحقل"
//     )}
//   </div>
// )}
